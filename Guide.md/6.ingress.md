# üéØ Tutorial 6: Nginx Ingress Controller 

---

## üìã Vad du kommer g√∂ra:

Ist√§llet f√∂r **2 separata Load Balancers** ($40/m√•nad):
- `todo-webapp-service` ‚Üí LoadBalancer 1
- `mongo-express-service` ‚Üí LoadBalancer 2

F√•r du **1 Load Balancer** med Ingress ($20/m√•nad):
- `todo-app.mydomain.tld` ‚Üí Ingress ‚Üí `todo-webapp-service`
- `mongo-express.mydomain.tld` ‚Üí Ingress ‚Üí `mongo-express-service`

**Spar $20/m√•nad!** üí∞

---

## ‚úÖ Prerequisites Check

```bash
# Kolla nodes
kubectl get nodes

# Kolla Helm version
helm version

# Kolla att todo-app k√∂rs
kubectl get pods -n todo-app
kubectl get svc -n todo-app
```
### Alternativ f√∂r helm: Ladda ner via winget (Enklast!)
Om du har Windows 11, har du winget!
I PowerShell:
winget install Helm.Helm

Det installerar Helm automatiskt och l√§gger till i PATH!
Efter installation, starta om Git Bash och testa:
helm version

---

## üöÄ Steg 1: Installera Nginx Ingress Controller

### 1.1 L√§gg till Helm Repository

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
```

**F√∂rv√§ntat:**
```
"ingress-nginx" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "ingress-nginx" chart repository
```

---

### 1.2 Skapa Helm Values File

**Skapa fil i VS Code:**

```bash
cd ~/AWS-Kubernetes/todo-app
code ingress-nginx-values.yaml
```

**Klistra in:**

```yaml
# ingress-nginx-values.yaml
controller:
  # The kind of deployment to use
  kind: DaemonSet

  # Configuration for the controller's service
  service:
    # Key annotations for AWS auto-provisioning
    annotations:
      # Specifies the type of AWS load balancer to create. "nlb" is for Network Load Balancer.
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

      # Optional: Sets the NLB to be internet-facing. Use "internal" for a private NLB.
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"

    # Set externalTrafficPolicy to Local to preserve the source IP of the client
    externalTrafficPolicy: Local
```

**Spara filen!**

---

### 1.3 Installera med Helm

```bash
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --values ingress-nginx-values.yaml
```

**F√∂rv√§ntat:**
```
NAME: ingress-nginx
LAST DEPLOYED: ...
NAMESPACE: ingress-nginx
STATUS: deployed
REVISION: 1
```

---

### 1.4 Verifiera Installation

**Kolla pods:**

```bash
kubectl get pods -n ingress-nginx
```

**F√∂rv√§ntat:**
```
NAME                             READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-xxxxx   1/1     Running   0          30s
```

**Kolla service (Load Balancer):**

```bash
kubectl get svc -n ingress-nginx -w
```

**Initialt:**
```
NAME                       TYPE           EXTERNAL-IP   PORT(S)
ingress-nginx-controller   LoadBalancer   <pending>     80:xxxxx/TCP,443:xxxxx/TCP
```

**Efter 2-3 minuter:**
```
NAME                       TYPE           EXTERNAL-IP                               PORT(S)
ingress-nginx-controller   LoadBalancer   k8s-ingressn-xxxx.elb.eu-west-1.amazonaws.com   80:xxxxx/TCP,443:xxxxx/TCP
```

**Tryck Ctrl+C n√§r du ser EXTERNAL-IP!**

**Kolla IngressClass:**

```bash
kubectl get ingressclass
```

**F√∂rv√§ntat:**
```
NAME    CONTROLLER             PARAMETERS   AGE
nginx   k8s.io/ingress-nginx   <none>       2m
```

---


**Allt fungerar direkt!** ‚úÖ

- ‚úÖ Pod k√∂rs
- ‚úÖ LoadBalancer har EXTERNAL-IP (NLB)
- ‚úÖ Ports 80 och 443 exponerade

---

## ‚úÖ Kolla IngressClass

```bash
kubectl get ingressclass
```

**F√∂rv√§ntat:**
```
NAME    CONTROLLER             PARAMETERS   AGE
nginx   k8s.io/ingress-nginx   <none>       1m
```

---

## üéØ Steg 2: Skapa Ingress Resource

Nu skapar vi Ingress som routar till dina services!

### 2.1 Spara NLB hostname

```bash
kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' && echo
```

**Output:**
```
k8s-ingressn-ingressn-b1f8c6415f-fb667d449060159b.elb.eu-west-1.amazonaws.com
```

**Kopiera denna URL!** üìã

---

### 2.2 Skapa Ingress Manifest

**Skapa filen:**

```bash
cd ~/AWS-Kubernetes/todo-app
cat > ingress.yaml << 'EOF'
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: todo-ingress
  namespace: todo-app
spec:
  ingressClassName: nginx
  rules:
  # Route 1: Todo App
  - host: todo-app.mydomain.tld
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: todo-webapp-service
            port:
              number: 80
  # Route 2: Mongo Express
  - host: mongo-express.mydomain.tld
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mongo-express-service
            port:
              number: 80
  # Route 3: Catch-all (default backend)
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: todo-webapp-service
            port:
              number: 80
EOF
```

**Verifiera:**

```bash
cat ingress.yaml
```

---

### 2.3 Apply Ingress

```bash
kubectl apply -f ingress.yaml
```

**F√∂rv√§ntat:**
```
ingress.networking.k8s.io/todo-ingress created
```

---

### 2.4 Verifiera Ingress

```bash
kubectl get ingress -n todo-app
```

**F√∂rv√§ntat:**
```
NAME           CLASS   HOSTS                                              ADDRESS           PORTS   AGE
todo-ingress   nginx   todo-app.mydomain.tld,mongo-express.mydomain.tld   k8s-ingressn...   80      10s
```

**Viktigt: Kolla att CLASS visar "nginx"!** ‚úÖ

**Detailed info:**

```bash
kubectl describe ingress todo-ingress -n todo-app
```

---

## üéØ Steg 3: Testa innan vi √§ndrar hosts file

### 3.1 Testa med Host header

```bash
# Testa Todo App
curl -H "Host: todo-app.mydomain.tld" http://k8s-ingressn-ingressn-b1f8c6415f-fb667d449060159b.elb.eu-west-1.amazonaws.com/
```

**F√∂rv√§ntat:** HTML fr√•n todo-app!

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Todo App</title>
...
```

---

# üéâ Perfekt! Nu fixar vi hosts file!

---

## üåê Steg 4: H√§mta NLB IP-adress

### 4.1 F√• NLB hostname

```bash
kubectl get ingress todo-ingress -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' && echo
```

**Output:**
```
k8s-ingressn-ingressn-b1f8c6415f-fb667d449060159b.elb.eu-west-1.amazonaws.com
```

---

### 4.2 Resolve till IP-adress

```bash
nslookup $(kubectl get ingress todo-ingress -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
```

**Output (exempel):**
```
Server:  UnKnown
Address:  192.168.1.1

Non-authoritative answer:
Name:    k8s-ingressn-ingressn-b1f8c6415f-fb667d449060159b.elb.eu-west-1.amazonaws.com
Addresses:  63.35.45.207
            52.18.123.45
```

**Kopiera den f√∂rsta IP-adressen!** üìã (t.ex. `63.35.45.207`)

---

## üìù Steg 5: Editera Hosts File (Windows)

### Metod 1: Notepad (Enklast)

1. **Tryck Windows-knappen**
2. **Skriv:** `notepad`
3. **H√∂gerklicka p√• Notepad**
4. **V√§lj "Run as administrator"**
5. I Notepad: **File ‚Üí Open**
6. **Bl√§ddra till:**
   ```
   C:\Windows\System32\drivers\etc\
   ```
7. **√Ñndra filter fr√•n "Text Documents" till "All Files (.)"**
8. **√ñppna filen:** `hosts`
9. **Scrolla ner l√§ngst ner** och l√§gg till (anv√§nd DIN IP):

```
63.35.45.207    todo-app.mydomain.tld
63.35.45.207    mongo-express.mydomain.tld
```

10. **File ‚Üí Save**
11. **St√§ng Notepad**

---

### Metod 2: PowerShell (Snabbare)

**√ñppna PowerShell som Administrator:**

```powershell
# Ers√§tt med DIN IP-adress!
Add-Content -Path C:\Windows\System32\drivers\etc\hosts -Value "`n63.35.45.207    todo-app.mydomain.tld"
Add-Content -Path C:\Windows\System32\drivers\etc\hosts -Value "63.35.45.207    mongo-express.mydomain.tld"
```

---

### 5.1 Verifiera hosts file

**I PowerShell:**

```powershell
Get-Content C:\Windows\System32\drivers\etc\hosts | Select-String mydomain
```

**F√∂rv√§ntat:**
```
63.35.45.207    todo-app.mydomain.tld
63.35.45.207    mongo-express.mydomain.tld
```

---

### 5.2 Flush DNS Cache

**I PowerShell (som Administrator):**

```powershell
ipconfig /flushdns
```

**Output:**
```
Successfully flushed the DNS Resolver Cache.
```

---

## üåê Steg 6: Testa i Webbl√§sare!

### 6.1 Testa Todo App

**√ñppna i webbl√§sare:**
```
http://todo-app.mydomain.tld
```

**Du ska se din Todo-app!** üéâ

---

### 6.2 Testa Mongo Express

**√ñppna i webbl√§sare:**
```
http://mongo-express.mydomain.tld
```

**Du ska se Basic Auth login!**
- **Username:** `admin`
- **Password:** `pass`

---

### 6.3 Testa fr√•n Git Bash

```bash
# Testa DNS resolution
ping todo-app.mydomain.tld

# Testa HTTP
curl http://todo-app.mydomain.tld

# Testa Mongo Express
curl http://mongo-express.mydomain.tld
```

---

## **N√§r detta fungerar √§r HELA tutorialen KLAR!** üéä