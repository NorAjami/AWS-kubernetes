#### (obs! du kan v√§lja mellan denna guide eller guide 4.Helm, k√∂r en av dem, ej b√•da)

## ‚ö†Ô∏è Viktigt: Docker Hub-konto

Tutorial anv√§nder `norajami/todo-app` som image-namn.

**Du beh√∂ver antingen:**
**Alternativ A:** Skapa eget Docker Hub-konto och pusha din image ‚úÖ (Rekommenderat)  
**Alternativ B:** Anv√§nd Nors befintliga image (funkar men inte ditt projekt).

---

## üìÅ Steg 1: Skapa Kustomize-struktur

Vi skapar alla mappar vi beh√∂ver f√∂r Tutorial 3.

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa alla mappar p√• en g√•ng
mkdir -p kubernetes/base
mkdir -p kubernetes/overlays/eks-dockerhub
```

### Verifiera:

```bash
tree kubernetes
```

**Eller om tree inte finns:**

```bash
ls -R kubernetes
```

**Du ska se:**
```
kubernetes/
‚îú‚îÄ‚îÄ base/
‚îî‚îÄ‚îÄ overlays/
    ‚îî‚îÄ‚îÄ eks-dockerhub/
```

---

## üìù Steg 2: Skapa Base manifests

Nu ska vi skapa **7 YAML-filer** i `base/`-mappen.

**Vi g√∂r detta i VS Code!**

### √ñppna VS Code:

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

---

## üìÑ Fil 1: namespace.yaml

### I VS Code:

1. **H√∂gerklicka** p√• `kubernetes/base/`-mappen
2. V√§lj **"New File"**
3. Namnge: `namespace.yaml`
4. **Klistra in:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: todo-app
```

5. **Spara** (Ctrl+S)

---

## üìÑ Fil 2: mongodb-statefulset.yaml

1. **H√∂gerklicka** p√• `kubernetes/base/`
2. **New File** ‚Üí `mongodb-statefulset.yaml`
3. **Klistra in:**

```yaml
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
  namespace: todo-app
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  clusterIP: None  # Headless service for stable network identity

---
# StatefulSet with persistent storage
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: todo-app
spec:
  serviceName: mongodb-service
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:latest
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: ""  # Empty - will be set by overlay
      resources:
        requests:
          storage: 1Gi
```

4. **Spara**

---

## üìÑ Fil 3: mongodb-init-job.yaml

1. **New File** ‚Üí `mongodb-init-job.yaml`
2. **Klistra in:**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init
  namespace: todo-app
spec:
  template:
    spec:
      containers:
      - name: mongo-init
        image: mongo:latest
        command:
        - /bin/bash
        - -c
        - |
          sleep 10
          mongosh mongodb-service:27017/ToDoAppDb --eval '
            db.TodoItems.insertMany([
              {
                "Id": 1,
                "Name": "Learn Kubernetes",
                "IsComplete": false
              },
              {
                "Id": 2,
                "Name": "Deploy MongoDB",
                "IsComplete": true
              }
            ]);
            print("Database initialized successfully!");
          '          
      restartPolicy: OnFailure
  backoffLimit: 4
```

3. **Spara**

---

## üìÑ Fil 4: webapp-configmap.yaml

1. **New File** ‚Üí `webapp-configmap.yaml`
2. **Klistra in:**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
  namespace: todo-app
data:
  MONGODB_HOST: "mongodb-service"
  MONGODB_PORT: "27017"
  MONGODB_DATABASE: "ToDoAppDb"
```

3. **Spara**

---

## üìÑ Fil 5: webapp-deployment.yaml

1. **New File** ‚Üí `webapp-deployment.yaml`
2. **Klistra in:**

```yaml
# Service for WebApp
apiVersion: v1
kind: Service
metadata:
  name: todo-webapp-service
  namespace: todo-app
  labels:
    app: todo-webapp
spec:
  type: LoadBalancer  # Default - will be overridden for docker-desktop
  selector:
    app: todo-webapp
  ports:
  - port: 80
    targetPort: 8080

---
# WebApp Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-webapp
  namespace: todo-app
  labels:
    app: todo-webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: todo-webapp
  template:
    metadata:
      labels:
        app: todo-webapp
    spec:
      containers:
      - name: webapp
        image: todo-app:latest  # Placeholder - replaced by overlay
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: webapp-config
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

3. **Spara**

---

## üìÑ Fil 6: mongo-express-deployment.yaml

1. **New File** ‚Üí `mongo-express-deployment.yaml`
2. **Klistra in:**

```yaml
# Service for Mongo Express
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
  namespace: todo-app
  labels:
    app: mongo-express
spec:
  type: LoadBalancer  # Default - will be overridden for docker-desktop
  selector:
    app: mongo-express
  ports:
  - port: 80
    targetPort: 8081

---
# Mongo Express Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  namespace: todo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: mongo-express:latest
        ports:
        - containerPort: 8081
        env:
        - name: ME_CONFIG_MONGODB_URL
          value: "mongodb://mongodb-service:27017"
        - name: ME_CONFIG_BASICAUTH_USERNAME
          value: "admin"
        - name: ME_CONFIG_BASICAUTH_PASSWORD
          value: "pass"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

3. **Spara**

---

## üìÑ Fil 7: kustomization.yaml (Base)

1. **New File** i `kubernetes/base/` ‚Üí `kustomization.yaml`
2. **Klistra in:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - namespace.yaml
  - mongodb-statefulset.yaml
  - mongodb-init-job.yaml
  - webapp-configmap.yaml
  - mongo-express-deployment.yaml
  - webapp-deployment.yaml
```

3. **Spara**

---

## ‚úÖ Verifiera base-filerna

**I VS Code sidopanel ska du nu se:**

```
kubernetes/
‚îî‚îÄ‚îÄ base/
    ‚îú‚îÄ‚îÄ kustomization.yaml
    ‚îú‚îÄ‚îÄ namespace.yaml
    ‚îú‚îÄ‚îÄ mongodb-statefulset.yaml
    ‚îú‚îÄ‚îÄ mongodb-init-job.yaml
    ‚îú‚îÄ‚îÄ webapp-configmap.yaml
    ‚îú‚îÄ‚îÄ webapp-deployment.yaml
    ‚îî‚îÄ‚îÄ mongo-express-deployment.yaml
```

**7 filer totalt i base/** ‚úÖ

---

# üéØ Steg 3: Skapa EKS Overlay-filer

Nu skapar vi overlay f√∂r **EKS + Docker Hub** deployment!

---

## üìÑ Fil 1: kustomization.yaml (EKS overlay)

### I VS Code:

1. **H√∂gerklicka** p√• `kubernetes/overlays/eks-dockerhub/`-mappen
2. V√§lj **"New File"**
3. Namnge: `kustomization.yaml`
4. **Klistra in:**


### (OBS! anv√§nd din docker hub image/namn i koden)

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: todo-app

resources:
  - ../../base
  - storageclass.yaml

# Use YOUR Docker Hub image
images:
  - name: todo-app
    newName: norajami/todo-app
    newTag: latest

# Patch MongoDB to use EKS StorageClass and add AWS LoadBalancer annotations
patches:
  - target:
      group: apps
      version: v1
      kind: StatefulSet
      name: mongodb
    patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: ebs-sc      
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: todo-webapp-service
        namespace: todo-app
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      spec:
        type: LoadBalancer      
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: mongo-express-service
        namespace: todo-app
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      spec:
        type: LoadBalancer
```

5. **Spara**


---

## üìÑ Fil 2: storageclass.yaml

1. **New File** i `kubernetes/overlays/eks-dockerhub/` ‚Üí `storageclass.yaml`
2. **Klistra in:**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-sc
provisioner: ebs.csi.eks.amazonaws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  encrypted: "true"
```

3. **Spara**

---

## ‚úÖ Verifiera overlay-struktur

**I VS Code ska du nu se:**

```
kubernetes/
‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îú‚îÄ‚îÄ kustomization.yaml
‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml
‚îÇ   ‚îú‚îÄ‚îÄ mongodb-statefulset.yaml
‚îÇ   ‚îú‚îÄ‚îÄ mongodb-init-job.yaml
‚îÇ   ‚îú‚îÄ‚îÄ webapp-configmap.yaml
‚îÇ   ‚îú‚îÄ‚îÄ webapp-deployment.yaml
‚îÇ   ‚îî‚îÄ‚îÄ mongo-express-deployment.yaml
‚îî‚îÄ‚îÄ overlays/
    ‚îî‚îÄ‚îÄ eks-dockerhub/
        ‚îú‚îÄ‚îÄ kustomization.yaml     ‚úÖ
        ‚îî‚îÄ‚îÄ storageclass.yaml      ‚úÖ
```
---

## üê≥ Steg 4: Bygg och pusha Docker image

Nu beh√∂ver vi f√• din webapp-image till Docker Hub!

### I Terminal:

(OBS! Byt till ditt anv√§ndarnamn)
```bash
cd ~/AWS-Kubernetes/todo-app/webapp

# Bygg image med DITT anv√§ndarnamn
docker build -t norajami/todo-app:latest .
```

**Detta tar 2-3 minuter f√∂rsta g√•ngen.**

**F√∂rv√§ntat output:**
```
[+] Building 45.2s (14/14) FINISHED
 => => naming to docker.io/norajami/todo-app:latest
```

### Pusha till Docker Hub:

```bash
docker push norajami/todo-app:latest
```

**F√∂rv√§ntat output:**
```
The push refers to repository [docker.io/norajami/todo-app]
latest: digest: sha256:abc123... size: 1234
```

---

## ‚úÖ Verifiera p√• Docker Hub

1. G√• till: https://hub.docker.com/repositories/norajami
2. Du ska se `todo-app` repository
3. Klicka p√• den ‚Üí Se `latest` tag ‚úÖ

---

## üéØ Steg 5: Preview Kustomize build

L√•t oss se vad Kustomize kommer deploya!

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl kustomize kubernetes/overlays/eks-dockerhub
```

**Detta visar alla YAML-filer efter Kustomize har applicerat patches.**

Du ska se massa output med:
- Namespace
- StatefulSet (MongoDB med `ebs-sc` storageClass)
- Services (med LoadBalancer och AWS-annotations)
- Deployments (med `Anv√§ndarnamn/todo-app:latest` image)

---

## üöÄ Steg 6: Deploy till EKS!

**Nu √§r det dags!**

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl apply -k kubernetes/overlays/eks-dockerhub
```

**F√∂rv√§ntat output:**
```
namespace/todo-app created
storageclass.storage.k8s.io/ebs-sc created
service/mongodb-service created
statefulset.apps/mongodb created
job.batch/mongodb-init created
configmap/webapp-config created
service/mongo-express-service created
deployment.apps/mongo-express created
service/todo-webapp-service created
deployment.apps/todo-webapp created
```

---

## üëÄ Steg 7: √ñvervaka deployment

```bash
# Kolla alla resurser
kubectl get all -n todo-app

# Kolla pods (kan ta 2-3 minuter)
kubectl get pods -n todo-app -w
```

**Du ska se:**
- mongodb-0 ‚Üí Running
- mongodb-init-xxx ‚Üí Completed
- mongo-express-xxx ‚Üí Running
- todo-webapp-xxx (2 replicas) ‚Üí Running

**Tryck Ctrl+C** n√§r alla √§r Running!

## Extra: Kolla services (Load Balancers)
bashkubectl get svc -n todo-app -w
Du kommer se:

mongodb-service (ClusterIP - intern)
todo-webapp-service (LoadBalancer - <pending> ‚Üí AWS DNS)
mongo-express-service (LoadBalancer - <pending> ‚Üí AWS DNS)

Load Balancers tar 2-3 minuter att provisiona!

---

## üìã Vad h√§nder nu i din AWS?

**EKS skapar automatiskt:**
- ‚úÖ EBS volume f√∂r MongoDB (1GB)
- ‚úÖ 2x Classic Load Balancers (en f√∂r webapp, en f√∂r mongo-express)
- ‚úÖ Security groups
- ‚úÖ Target groups

**Detta tar ~3-5 minuter!**

---
üåê Steg 8: H√§mta Load Balancer-URL:erna
Nu ska vi f√• URL:erna till din Todo-app i molnet!

Kolla services:
bashkubectl get svc -n todo-app
Du ska se n√•got liknande:
NAME                      TYPE           EXTERNAL-IP
mongodb-service           ClusterIP      None
todo-webapp-service       LoadBalancer   abc123-xyz.elb.eu-west-1.amazonaws.com
mongo-express-service     LoadBalancer   def456-abc.elb.eu-west-1.amazonaws.com

H√§mta Todo App-URL:
bashkubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
Kopiera URL:en som visas!

H√§mta Mongo Express-URL:
bashkubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
Kopiera denna URL ocks√•!

Eller enklare - f√• b√•da samtidigt:
bashecho "Todo App: http://$(kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')"

echo "Mongo Express: http://$(kubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')"

üåç Steg 9: Testa appen i molnet!
√ñppna Todo App i webbl√§sare:
http://WEBAPP-URL-FR√ÖN-OVAN
Du ska se:

üé® Samma lila gradient-design
üìù Tv√• sample todos ("Learn Kubernetes", "Deploy MongoDB")
‚ú® Fungerande CRUD-operations

Testa funktioner:

‚úÖ L√§gg till en todo
‚úÖ Markera som klar
‚úÖ Radera en todo
‚úÖ Uppdatera sidan ‚Üí Allt finns kvar!


√ñppna Mongo Express (valfritt):
http://MONGO-EXPRESS-URL
Login:

Username: admin
Password: pass

Kolla databasen:

ToDoAppDb ‚Üí TodoItems ‚Üí Se alla todos som JSON!


üéä GRATTIS! Din app k√∂rs i molnet! ‚òÅÔ∏è
Vad du just gjort:

‚úÖ Deployat full-stack app till AWS EKS
‚úÖ MongoDB med persistent EBS storage
‚úÖ 2x Load Balancers f√∂r internet access
‚úÖ 2 webapp-replicas f√∂r redundans
‚úÖ Allt orkesterat med Kustomize!


üìä Verifiera ytterligare (valfritt):
Kolla pods k√∂rs i flera nodes:
bashkubectl get pods -n todo-app -o wide
NODE-kolumnen visar f√∂rdelning √∂ver dina 2 nodes!
Kolla persistent volume:
bashkubectl get pvc -n todo-app
Du ska se EBS-volume p√• 1Gi!
Kolla i AWS Console (valfritt):

EC2 Console ‚Üí Load Balancers ‚Üí Se dina 2 Classic Load Balancers
EC2 Console ‚Üí Volumes ‚Üí Se EBS-volymen f√∂r MongoDB 