#### (obs! du kan vÃ¤lja mellan denna guide eller guide 4.Helm, kÃ¶r en av dem, ej bÃ¥da)

## âš ï¸ Viktigt: Docker Hub-konto

Tutorial anvÃ¤nder `norajami/todo-app` som image-namn.

**Du behÃ¶ver antingen:**
**Alternativ A:** Skapa eget Docker Hub-konto och pusha din image âœ… (Rekommenderat)  
**Alternativ B:** AnvÃ¤nd Nors befintliga image (funkar men inte ditt projekt).

---

## ğŸ“ Steg 1: Skapa Kustomize-struktur

Vi skapar alla mappar vi behÃ¶ver fÃ¶r Tutorial 3.

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa alla mappar pÃ¥ en gÃ¥ng
mkdir -p kubernetes/base
mkdir -p kubernetes/overlays/eks-dockerhub
```

### Verifiera:

```bash
tree kubernetes
```

**Eller om tree inte finns:**

```bash
ls -R kubernetes
```

**Du ska se:**
```
kubernetes/
â”œâ”€â”€ base/
â””â”€â”€ overlays/
    â””â”€â”€ eks-dockerhub/
```

---

## ğŸ“ Steg 2: Skapa Base manifests

Nu ska vi skapa **7 YAML-filer** i `base/`-mappen.

**Vi gÃ¶r detta i VS Code!**

### Ã–ppna VS Code:

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

---

## ğŸ“„ Fil 1: namespace.yaml

### I VS Code:

1. **HÃ¶gerklicka** pÃ¥ `kubernetes/base/`-mappen
2. VÃ¤lj **"New File"**
3. Namnge: `namespace.yaml`
4. **Klistra in:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: todo-app
```

5. **Spara** (Ctrl+S)

---

## ğŸ“„ Fil 2: mongodb-statefulset.yaml

1. **HÃ¶gerklicka** pÃ¥ `kubernetes/base/`
2. **New File** â†’ `mongodb-statefulset.yaml`
3. **Klistra in:**

```yaml
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
  namespace: todo-app
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  clusterIP: None  # Headless service for stable network identity

---
# StatefulSet with persistent storage
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: todo-app
spec:
  serviceName: mongodb-service
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:latest
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: ""  # Empty - will be set by overlay
      resources:
        requests:
          storage: 1Gi
```

4. **Spara**

---

## ğŸ“„ Fil 3: mongodb-init-job.yaml

1. **New File** â†’ `mongodb-init-job.yaml`
2. **Klistra in:**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init
  namespace: todo-app
spec:
  template:
    spec:
      containers:
      - name: mongo-init
        image: mongo:latest
        command:
        - /bin/bash
        - -c
        - |
          sleep 10
          mongosh mongodb-service:27017/ToDoAppDb --eval '
            db.TodoItems.insertMany([
              {
                "Id": 1,
                "Name": "Learn Kubernetes",
                "IsComplete": false
              },
              {
                "Id": 2,
                "Name": "Deploy MongoDB",
                "IsComplete": true
              }
            ]);
            print("Database initialized successfully!");
          '          
      restartPolicy: OnFailure
  backoffLimit: 4
```

3. **Spara**

---

## ğŸ“„ Fil 4: webapp-configmap.yaml

1. **New File** â†’ `webapp-configmap.yaml`
2. **Klistra in:**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
  namespace: todo-app
data:
  MONGODB_HOST: "mongodb-service"
  MONGODB_PORT: "27017"
  MONGODB_DATABASE: "ToDoAppDb"
```

3. **Spara**

---

## ğŸ“„ Fil 5: webapp-deployment.yaml

1. **New File** â†’ `webapp-deployment.yaml`
2. **Klistra in:**

```yaml
# Service for WebApp
apiVersion: v1
kind: Service
metadata:
  name: todo-webapp-service
  namespace: todo-app
  labels:
    app: todo-webapp
spec:
  type: LoadBalancer  # Default - will be overridden for docker-desktop
  selector:
    app: todo-webapp
  ports:
  - port: 80
    targetPort: 8080

---
# WebApp Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-webapp
  namespace: todo-app
  labels:
    app: todo-webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: todo-webapp
  template:
    metadata:
      labels:
        app: todo-webapp
    spec:
      containers:
      - name: webapp
        image: todo-app:latest  # Placeholder - replaced by overlay
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: webapp-config
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

3. **Spara**

---

## ğŸ“„ Fil 6: mongo-express-deployment.yaml

1. **New File** â†’ `mongo-express-deployment.yaml`
2. **Klistra in:**

```yaml
# Service for Mongo Express
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
  namespace: todo-app
  labels:
    app: mongo-express
spec:
  type: LoadBalancer  # Default - will be overridden for docker-desktop
  selector:
    app: mongo-express
  ports:
  - port: 80
    targetPort: 8081

---
# Mongo Express Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  namespace: todo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: mongo-express:latest
        ports:
        - containerPort: 8081
        env:
        - name: ME_CONFIG_MONGODB_URL
          value: "mongodb://mongodb-service:27017"
        - name: ME_CONFIG_BASICAUTH_USERNAME
          value: "admin"
        - name: ME_CONFIG_BASICAUTH_PASSWORD
          value: "pass"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

3. **Spara**

---

## ğŸ“„ Fil 7: kustomization.yaml (Base)

1. **New File** i `kubernetes/base/` â†’ `kustomization.yaml`
2. **Klistra in:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - namespace.yaml
  - mongodb-statefulset.yaml
  - mongodb-init-job.yaml
  - webapp-configmap.yaml
  - mongo-express-deployment.yaml
  - webapp-deployment.yaml
```

3. **Spara**

---

## âœ… Verifiera base-filerna

**I VS Code sidopanel ska du nu se:**

```
kubernetes/
â””â”€â”€ base/
    â”œâ”€â”€ kustomization.yaml
    â”œâ”€â”€ namespace.yaml
    â”œâ”€â”€ mongodb-statefulset.yaml
    â”œâ”€â”€ mongodb-init-job.yaml
    â”œâ”€â”€ webapp-configmap.yaml
    â”œâ”€â”€ webapp-deployment.yaml
    â””â”€â”€ mongo-express-deployment.yaml
```

**7 filer totalt i base/** âœ…

---

# ğŸ¯ Steg 3: Skapa EKS Overlay-filer

Nu skapar vi overlay fÃ¶r **EKS + Docker Hub** deployment!

---

## ğŸ“„ Fil 1: kustomization.yaml (EKS overlay)

### I VS Code:

1. **HÃ¶gerklicka** pÃ¥ `kubernetes/overlays/eks-dockerhub/`-mappen
2. VÃ¤lj **"New File"**
3. Namnge: `kustomization.yaml`
4. **Klistra in:**


### (OBS! anvÃ¤nd din docker hub image/namn i koden)

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: todo-app

resources:
  - ../../base
  - storageclass.yaml

# Use YOUR Docker Hub image
images:
  - name: todo-app
    newName: norajami/todo-app
    newTag: latest

# Patch MongoDB to use EKS StorageClass and add AWS LoadBalancer annotations
patches:
  - target:
      group: apps
      version: v1
      kind: StatefulSet
      name: mongodb
    patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: ebs-sc      
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: todo-webapp-service
        namespace: todo-app
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      spec:
        type: LoadBalancer      
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: mongo-express-service
        namespace: todo-app
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      spec:
        type: LoadBalancer
```

5. **Spara**


---

## ğŸ“„ Fil 2: storageclass.yaml

1. **New File** i `kubernetes/overlays/eks-dockerhub/` â†’ `storageclass.yaml`
2. **Klistra in:**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-sc
provisioner: ebs.csi.eks.amazonaws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  encrypted: "true"
```

3. **Spara**

---

## âœ… Verifiera overlay-struktur

**I VS Code ska du nu se:**

```
kubernetes/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”œâ”€â”€ mongodb-statefulset.yaml
â”‚   â”œâ”€â”€ mongodb-init-job.yaml
â”‚   â”œâ”€â”€ webapp-configmap.yaml
â”‚   â”œâ”€â”€ webapp-deployment.yaml
â”‚   â””â”€â”€ mongo-express-deployment.yaml
â””â”€â”€ overlays/
    â””â”€â”€ eks-dockerhub/
        â”œâ”€â”€ kustomization.yaml     âœ…
        â””â”€â”€ storageclass.yaml      âœ…
```
---

## ğŸ³ Steg 4: Bygg och pusha Docker image

Nu behÃ¶ver vi fÃ¥ din webapp-image till Docker Hub!

### I Terminal:

(OBS! Byt till ditt anvÃ¤ndarnamn)
```bash
cd ~/AWS-Kubernetes/todo-app/webapp

# Bygg image med DITT anvÃ¤ndarnamn
docker build -t norajami/todo-app:latest .
```

**Detta tar 2-3 minuter fÃ¶rsta gÃ¥ngen.**

**FÃ¶rvÃ¤ntat output:**
```
[+] Building 45.2s (14/14) FINISHED
 => => naming to docker.io/norajami/todo-app:latest
```

### Pusha till Docker Hub:

```bash
docker push norajami/todo-app:latest
```

**FÃ¶rvÃ¤ntat output:**
```
The push refers to repository [docker.io/norajami/todo-app]
latest: digest: sha256:abc123... size: 1234
```

---

## âœ… Verifiera pÃ¥ Docker Hub

1. GÃ¥ till: https://hub.docker.com/repositories/norajami
2. Du ska se `todo-app` repository
3. Klicka pÃ¥ den â†’ Se `latest` tag âœ…

---

## ğŸ¯ Steg 5: Preview Kustomize build

LÃ¥t oss se vad Kustomize kommer deploya!

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl kustomize kubernetes/overlays/eks-dockerhub
```

**Detta visar alla YAML-filer efter Kustomize har applicerat patches.**

Du ska se massa output med:
- Namespace
- StatefulSet (MongoDB med `ebs-sc` storageClass)
- Services (med LoadBalancer och AWS-annotations)
- Deployments (med `AnvÃ¤ndarnamn/todo-app:latest` image)

---

## ğŸš€ Steg 6: Deploy till EKS!

**Nu Ã¤r det dags!**

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl apply -k kubernetes/overlays/eks-dockerhub
```

**FÃ¶rvÃ¤ntat output:**
```
namespace/todo-app created
storageclass.storage.k8s.io/ebs-sc created
service/mongodb-service created
statefulset.apps/mongodb created
job.batch/mongodb-init created
configmap/webapp-config created
service/mongo-express-service created
deployment.apps/mongo-express created
service/todo-webapp-service created
deployment.apps/todo-webapp created
```

---

## ğŸ‘€ Steg 7: Ã–vervaka deployment

```bash
# Kolla alla resurser
kubectl get all -n todo-app

# Kolla pods (kan ta 2-3 minuter)
kubectl get pods -n todo-app -w
```

**Du ska se:**
- mongodb-0 â†’ Running
- mongodb-init-xxx â†’ Completed
- mongo-express-xxx â†’ Running
- todo-webapp-xxx (2 replicas) â†’ Running

**Tryck Ctrl+C** nÃ¤r alla Ã¤r Running!

## Extra: Kolla services (Load Balancers)
bashkubectl get svc -n todo-app -w
Du kommer se:

mongodb-service (ClusterIP - intern)
todo-webapp-service (LoadBalancer - <pending> â†’ AWS DNS)
mongo-express-service (LoadBalancer - <pending> â†’ AWS DNS)

Load Balancers tar 2-3 minuter att provisiona!

---

## ğŸ“‹ Vad hÃ¤nder nu i din AWS?

**EKS skapar automatiskt:**
- âœ… EBS volume fÃ¶r MongoDB (1GB)
- âœ… 2x Classic Load Balancers (en fÃ¶r webapp, en fÃ¶r mongo-express)
- âœ… Security groups
- âœ… Target groups

**Detta tar ~3-5 minuter!**

---
ğŸŒ Steg 8: HÃ¤mta Load Balancer-URL:erna
Nu ska vi fÃ¥ URL:erna till din Todo-app i molnet!

Kolla services:
bashkubectl get svc -n todo-app
Du ska se nÃ¥got liknande:
NAME                      TYPE           EXTERNAL-IP
mongodb-service           ClusterIP      None
todo-webapp-service       LoadBalancer   abc123-xyz.elb.eu-west-1.amazonaws.com
mongo-express-service     LoadBalancer   def456-abc.elb.eu-west-1.amazonaws.com

HÃ¤mta Todo App-URL:
bashkubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
Kopiera URL:en som visas!

HÃ¤mta Mongo Express-URL:
bashkubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
Kopiera denna URL ocksÃ¥!

Eller enklare - fÃ¥ bÃ¥da samtidigt:
bashecho "Todo App: http://$(kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')"

echo "Mongo Express: http://$(kubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')"

ğŸŒ Steg 9: Testa appen i molnet!
Ã–ppna Todo App i webblÃ¤sare:
http://WEBAPP-URL-FRÃ…N-OVAN
Du ska se:

ğŸ¨ Samma lila gradient-design
ğŸ“ TvÃ¥ sample todos ("Learn Kubernetes", "Deploy MongoDB")
âœ¨ Fungerande CRUD-operations

Testa funktioner:

âœ… LÃ¤gg till en todo
âœ… Markera som klar
âœ… Radera en todo
âœ… Uppdatera sidan â†’ Allt finns kvar!


Ã–ppna Mongo Express (valfritt):
http://MONGO-EXPRESS-URL
Login:

Username: admin
Password: pass

Kolla databasen:

ToDoAppDb â†’ TodoItems â†’ Se alla todos som JSON!


ğŸŠ GRATTIS! Din app kÃ¶rs i molnet! â˜ï¸
Vad du just gjort:

âœ… Deployat full-stack app till AWS EKS
âœ… MongoDB med persistent EBS storage
âœ… 2x Load Balancers fÃ¶r internet access
âœ… 2 webapp-replicas fÃ¶r redundans
âœ… Allt orkesterat med Kustomize!


ğŸ“Š Verifiera ytterligare (valfritt):
Kolla pods kÃ¶rs i flera nodes:
bashkubectl get pods -n todo-app -o wide
NODE-kolumnen visar fÃ¶rdelning Ã¶ver dina 2 nodes!
Kolla persistent volume:
bashkubectl get pvc -n todo-app
Du ska se EBS-volume pÃ¥ 1Gi!
Kolla i AWS Console (valfritt):

EC2 Console â†’ Load Balancers â†’ Se dina 2 Classic Load Balancers
EC2 Console â†’ Volumes â†’ Se EBS-volymen fÃ¶r MongoDB 