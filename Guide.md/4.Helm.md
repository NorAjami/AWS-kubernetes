# **Helm**! 

---

## 📊 Tutorial 4 - Snabb översikt

**Helm vs Kustomize:**
- **Kustomize** (Tutorial 3): Patches och overlays
- **Helm** (Tutorial 4): Templates med variabler → Mer kraftfullt!

---

## ⚠️ VIKTIGT: Rensa först!

Innan vi börjar med Helm måste vi **radera** Kustomize-deploymenten från EKS (annars kommer de krocka - samma namespace och resurser!)

### Radera från EKS:

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl delete -k kubernetes/overlays/eks-dockerhub
```

**Förväntat:**
```
namespace "todo-app" deleted
storageclass "ebs-sc" deleted
service "mongodb-service" deleted
statefulset "mongodb" deleted
...
```

### Verifiera att allt är borta:

```bash
kubectl get all -n todo-app
```

**Förväntat:**
```
No resources found in todo-app namespace.
```

**Eller:**
```
Error from server (NotFound): namespaces "todo-app" not found
```

Båda är OK! ✅

---

## 🛠️ Installera Helm (om du inte har det)

```bash
helm version
```

**Om du får version:** Du har det redan! ✅

**Om "command not found":**

**Windows (med Chocolatey):**
```bash
choco install kubernetes-helm
```

**Eller ladda ner manuellt:**
1. Gå till: https://github.com/helm/helm/releases
2. Ladda ner `helm-v3.x.x-windows-amd64.zip`
3. Extrahera `helm.exe` till `C:\Program Files\helm\`
4. Lägg till i PATH
5. Starta om Terminal

---

## 📁 Steg 1: Skapa Helm Chart-struktur

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa ny mapp för Helm
mkdir helm-chart
cd helm-chart

# Skapa Helm chart (genererar grundstruktur)
helm create todo-app-chart
```

**Detta skapar:**
```
helm-chart/
└── todo-app-chart/
    ├── Chart.yaml
    ├── values.yaml
    ├── charts/
    └── templates/
        ├── deployment.yaml
        ├── service.yaml
        └── ...
```

### Rensa bort defaults:

```bash
cd todo-app-chart

# Ta bort default templates (vi skapar egna)
rm -rf templates/*.yaml templates/tests
```

---

## 📋 Nu ska vi skapa flera filer!

**Vi behöver skapa:**
1. ✅ `Chart.yaml` (metadata)
2. ✅ `values.yaml` (default config)
3. ✅ `values-eks-dockerhub.yaml` (EKS-specifik config)
4. ✅ 10 template-filer (i templates/)

**Detta är mer än Tutorial 3, men mer kraftfullt!**

---

## 💻 Öppna VS Code

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

---

AWS-Kubernetes/
├── todo-app/
│   ├── kubernetes/          (Kustomize - Tutorial 3) ✅
│   ├── helm-chart/          (Helm - Tutorial 4) ← NY!
│   │   └── todo-app-chart/
│   │       ├── Chart.yaml
│   │       ├── values.yaml
│   │       ├── values-eks-dockerhub.yaml
│   │       └── templates/
│   │           ├── _helpers.tpl
│   │           ├── namespace.yaml
│   │           ├── mongodb-statefulset.yaml
│   │           └── ... (10 filer)
│   └── ...

___

# 🚀 Perfekt! Steg-för-steg Helm Tutorial 4!

Vi skapar allting från grunden med förklaringar!

---

## 📁 Steg 1: Skapa Helm-struktur

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa mapp för Helm
mkdir helm-chart
cd helm-chart

# Skapa Helm chart med default struktur
helm create todo-app-chart
```

**Vad händer:**
- `helm create` genererar en grundstruktur
- Vi får templates, values.yaml, Chart.yaml automatiskt
- Men vi kommer ersätta allt innehåll!

### Verifiera:

```bash
ls todo-app-chart/
```

**Du ska se:**
```
Chart.yaml
charts/
templates/
values.yaml
```

---

## 🧹 Steg 2: Rensa default-filer

Vi vill skapa våra egna templates från scratch!

```bash
cd todo-app-chart

# Ta bort alla default templates
rm templates/*.yaml
rm -rf templates/tests

# Behåll bara _helpers.tpl (vi uppdaterar den senare)
```

### Verifiera:

```bash
ls templates/
```

**Ska endast visa:**
```
_helpers.tpl
NOTES.txt
```

---

## 💻 Steg 3: Öppna i VS Code

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

**I VS Code sidopanel ska du se:**
```
todo-app/
├── helm-chart/
│   └── todo-app-chart/
│       ├── Chart.yaml
│       ├── charts/
│       ├── templates/
│       │   ├── _helpers.tpl
│       │   └── NOTES.txt
│       └── values.yaml
├── kubernetes/         (Kustomize från Tutorial 3)
├── webapp/
└── ...
```

---

## 📄 Steg 4: Skapa Chart.yaml (Metadata)

### I VS Code:

1. **Öppna** `helm-chart/todo-app-chart/Chart.yaml`
2. **Radera allt** som finns där
3. **Klistra in:**

```yaml
apiVersion: v2
name: todo-app
description: A full-stack Todo application with MongoDB backend
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - todo
  - mongodb
  - asp.net
  - kubernetes
maintainers:
  - name: norajami
    email: norajami@gmail.com
```

4. **Spara** (Ctrl+S)

---

## 💡 Förklaring - Chart.yaml:

| Fält | Vad det betyder |
|------|-----------------|
| `apiVersion: v2` | Helm 3 format |
| `name` | Chart-namnet (används i kommandon) |
| `description` | Kort beskrivning av appen |
| `type: application` | Deployable app (vs "library") |
| `version` | Chart-version (ökas vid ändringar) |
| `appVersion` | Din applikations version |
| `keywords` | För sökning i Helm repos |
| `maintainers` | Vem som underhåller chartet |

**Skillnad från Kustomize:** 
- Kustomize har ingen metadata-fil
- Helm charts är "paket" som kan delas och versionshanteras

---

## 📝 Steg 5: Skapa _helpers.tpl (Template-funktioner)

### I VS Code:

1. **Öppna** `helm-chart/todo-app-chart/templates/_helpers.tpl`
2. **Radera allt**
3. **Klistra in:**

```go
{{/*
Expand the name of the chart.
*/}}
{{- define "todo-app.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
*/}}
{{- define "todo-app.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "todo-app.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
app.kubernetes.io/name: {{ include "todo-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "todo-app.selectorLabels" -}}
app.kubernetes.io/name: {{ include "todo-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}
```

4. **Spara**

---

## 💡 Förklaring - _helpers.tpl:

**Vad är detta?**
- Återanvändbara template-funktioner
- Definieras en gång, används överallt
- Go template-syntax

**Funktionerna:**

| Funktion | Vad den gör |
|----------|-------------|
| `todo-app.name` | Genererar app-namn (max 63 tecken) |
| `todo-app.fullname` | Fullständigt namn inklusive release |
| `todo-app.labels` | Standard Kubernetes-labels |
| `todo-app.selectorLabels` | Labels för selectors |

**Exempel användning:**
```yaml
metadata:
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
```

**Skillnad från Kustomize:**
- Kustomize: Inga funktioner, ren YAML
- Helm: Kraftfulla template-funktioner med logik

---

## 🎯 Nästa: values.yaml (Default-konfiguration)

**Detta är HJÄRTAT i Helm!** 

Här definierar vi alla variabler som templates använder.

___

# 📋 Steg 6: Skapa values.yaml (Default-konfiguration)

Detta är **hjärtat** i Helm - alla variabler definieras här!

---

## 📝 I VS Code:

1. **Öppna** `helm-chart/todo-app-chart/values.yaml`
2. **Radera allt** som finns där
3. **Klistra in:**

```yaml
# Default values for todo-app chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
namespace: todo-app

# Container image configuration
image:
  repository: norajami/todo-app
  tag: latest
  pullPolicy: Always

# MongoDB configuration
mongodb:
  enabled: true
  replicas: 1
  image: mongo:latest
  storage:
    enabled: true
    size: 1Gi
    # storageClass will be set per environment
    storageClass: ""
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  database: "ToDoAppDb"

# WebApp configuration
webapp:
  enabled: true
  replicas: 2
  port: 8080
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  service:
    type: LoadBalancer
    port: 80
    # NodePort for Docker Desktop (optional)
    nodePort: null
    # AWS Load Balancer annotations (only for EKS)
    annotations: {}

# Mongo Express configuration
mongoExpress:
  enabled: true
  replicas: 1
  image: mongo-express:latest
  port: 8081
  username: admin
  password: pass
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  service:
    type: LoadBalancer
    port: 80
    nodePort: null
    annotations: {}

# Init job configuration
initJob:
  enabled: true
  backoffLimit: 4
  todos:
    - id: 1
      name: "Learn Kubernetes"
      isComplete: false
    - id: 2
      name: "Deploy MongoDB"
      isComplete: true

# Storage class (environment-specific)
storageClass:
  enabled: false
  name: ebs-sc
  provisioner: ebs.csi.eks.amazonaws.com
  volumeBindingMode: WaitForFirstConsumer
  parameters:
    type: gp3
    encrypted: "true"
```

4. **Spara** (Ctrl+S)

---

## 💡 Förklaring - values.yaml struktur:

### 🔧 Varför är detta kraftfullt?

**Kustomize:**
```yaml
# Måste patcha varje fil separat
patches:
  - target: Deployment
    patch: change replicas
```

**Helm:**
```yaml
# En variabel ändrar allt
webapp:
  replicas: 2  # ← Ändra här, appliceras överallt
```

---

### 📊 Viktiga sektioner:

#### 1. **Image configuration**
```yaml
image:
  repository: norajami/todo-app  # ← Ditt Docker Hub-namn!
  tag: latest
  pullPolicy: Always
```

**Används i:** `webapp-deployment.yaml` template  
**Gör att:** Lätt byta image utan att redigera templates

---

#### 2. **MongoDB configuration**
```yaml
mongodb:
  enabled: true      # ← On/off switch!
  replicas: 1
  storage:
    storageClass: "" # ← Tomt = sätts per miljö
```

**Enabled-flaggor:**
- `enabled: false` → Hela MongoDB-resurser skippas
- Perfekt för dev-miljöer utan databas

---

#### 3. **Resources (CPU/Memory)**
```yaml
resources:
  requests:
    memory: "256Mi"  # Minsta garanterade
    cpu: "250m"      # 0.25 CPU cores
  limits:
    memory: "512Mi"  # Max tillåtet
    cpu: "500m"
```

**Kubernetes använder detta för:**
- Scheduling (vilken node passar?)
- Resource quota enforcement
- OOMKill om limit överskrids

---

#### 4. **Service configuration**
```yaml
service:
  type: LoadBalancer  # Ändras till NodePort för lokal
  port: 80
  nodePort: null      # Sätts för Docker Desktop
  annotations: {}     # AWS-specifika för EKS
```

**Dynamiskt!**
- Docker Desktop: NodePort + nodePort: 30080
- EKS: LoadBalancer + AWS annotations

---

#### 5. **Init Job todos (list/array)**
```yaml
initJob:
  todos:
    - id: 1
      name: "Learn Kubernetes"
    - id: 2
      name: "Deploy MongoDB"
```

**Template kommer loopa över denna array!**  
Lägg till fler todos → automatiskt i databasen

---

#### 6. **StorageClass (conditional)**
```yaml
storageClass:
  enabled: false  # ← Docker Desktop behöver inte, EKS gör det
```

**If-statement i template:**
```yaml
{{- if .Values.storageClass.enabled }}
# Skapa StorageClass
{{- end }}
```

---

## 🆚 Jämförelse: Kustomize vs Helm

### Samma uppgift: Ändra replicas

**Kustomize:**
```yaml
# kustomization.yaml
patches:
  - target:
      kind: Deployment
      name: todo-webapp
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
```

**Helm:**
```yaml
# values.yaml
webapp:
  replicas: 5
```

**Eller vid deploy:**
```bash
helm install todo-app . --set webapp.replicas=5
```

---

### Samma uppgift: Stäng av Mongo Express

**Kustomize:**
```yaml
# Måste kommentera bort i kustomization.yaml
resources:
  # - mongo-express-deployment.yaml  # Commented out
```

**Helm:**
```yaml
# values.yaml
mongoExpress:
  enabled: false
```

**Eller vid deploy:**
```bash
helm install todo-app . --set mongoExpress.enabled=false
```

---

## 🎯 Nyckelpunkter:

✅ **values.yaml = Central konfiguration**  
✅ **Alla templates läser härifrån**  
✅ **Lätt att overrida per miljö**  
✅ **Kan ändras via CLI (--set)**  
✅ **Strukturerat och läsbart**

---

## 📂 Nästa: Environment-specifika values

Vi skapar:
- `values-eks-dockerhub.yaml` - För EKS med Docker Hub

___


# 🌍 Steg 7: Skapa Environment-specifik Values

Nu skapar vi override-fil för **EKS med Docker Hub**!

---

## 📝 I VS Code:

1. **Högerklicka** på `helm-chart/todo-app-chart/`-mappen
2. Välj **"New File"**
3. Namnge: `values-eks-dockerhub.yaml`
4. **Klistra in:**

```yaml
# EKS environment with Docker Hub image
# This file overrides values.yaml for EKS deployments

# Use Docker Hub image (same as default, but explicit)
image:
  repository: norajami/todo-app
  tag: latest

# MongoDB storage - use EBS
mongodb:
  storage:
    storageClass: ebs-sc

# WebApp service - LoadBalancer with AWS annotations
webapp:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

# Mongo Express service - LoadBalancer with AWS annotations
mongoExpress:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

# Create EBS StorageClass
storageClass:
  enabled: true
  name: ebs-sc
  provisioner: ebs.csi.eks.amazonaws.com
  volumeBindingMode: WaitForFirstConsumer
  parameters:
    type: gp3
    encrypted: "true"
```

5. **Spara** (Ctrl+S)

---

## 💡 Förklaring - Environment overrides:

### 🔄 Hur Helm kombinerar values:

**När du kör:**
```bash
helm install todo-app . -f values-eks-dockerhub.yaml
```

**Helm gör:**
1. Läser `values.yaml` (defaults)
2. Läser `values-eks-dockerhub.yaml` (overrides)
3. **Mergar** dem (senare filer vinner)

---

### 📊 Vad händer i praktiken:

**values.yaml säger:**
```yaml
webapp:
  service:
    type: LoadBalancer
    annotations: {}  # Tom
```

**values-eks-dockerhub.yaml säger:**
```yaml
webapp:
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

**Resultat:**
```yaml
webapp:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

---

### 🔑 Nyckeldifferenser för EKS:

| Setting | Default (values.yaml) | EKS override |
|---------|----------------------|--------------|
| `storageClass.enabled` | `false` | `true` ✅ |
| `mongodb.storage.storageClass` | `""` | `ebs-sc` ✅ |
| `webapp.service.annotations` | `{}` | AWS internet-facing ✅ |
| `mongoExpress.service.annotations` | `{}` | AWS internet-facing ✅ |

---

### 🌐 Docker Desktop vs EKS - Side by side:

**Om vi hade skapat `values-docker-desktop.yaml`:**

```yaml
# Docker Desktop environment
image:
  repository: norajami/todo-app

mongodb:
  storage:
    storageClass: hostpath  # ← Lokal storage

webapp:
  service:
    type: NodePort          # ← Inte LoadBalancer
    nodePort: 30080         # ← Fixed port

mongoExpress:
  service:
    type: NodePort
    nodePort: 30081

storageClass:
  enabled: false            # ← Använd inbyggd
```

**Jämfört med EKS:**

```yaml
# EKS environment
mongodb:
  storage:
    storageClass: ebs-sc    # ← AWS EBS

webapp:
  service:
    type: LoadBalancer      # ← AWS ELB
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

storageClass:
  enabled: true             # ← Skapa EBS StorageClass
```

---

## 🎯 Fördelar med denna approach:

✅ **En kodbas** - Samma templates för alla miljöer  
✅ **Minimal duplication** - Endast skillnader i values-filer  
✅ **Lätt att jämföra** - Se exakt vad som skiljer miljöer  
✅ **Säker** - Kan inte råka deploya fel config  
✅ **Skalbar** - Lägg till `values-prod.yaml`, `values-staging.yaml`

---

## 🆚 Kustomize vs Helm - Environments:

**Kustomize:**
```
overlays/
├── docker-desktop/
│   ├── kustomization.yaml        (15 rader patches)
│   ├── webapp-service-patch.yaml (10 rader)
│   └── storage-patch.yaml        (8 rader)
└── eks-dockerhub/
    ├── kustomization.yaml        (20 rader patches)
    └── storageclass.yaml         (10 rader)
```
**= 63 rader totalt**

**Helm:**
```
values-docker-desktop.yaml  (15 rader)
values-eks-dockerhub.yaml   (20 rader)
```
**= 35 rader totalt**

**Och mer läsbart!** ✨

---

## 📂 Struktur hittills:

```
helm-chart/
└── todo-app-chart/
    ├── Chart.yaml                      ✅
    ├── values.yaml                     ✅
    ├── values-eks-dockerhub.yaml       ✅
    └── templates/
        ├── _helpers.tpl                ✅
        └── NOTES.txt
```

---

## 🎯 Nästa: Skapa Templates!

Nu börjar det roliga - vi skapar **templated Kubernetes manifests**!

Vi ska skapa **10 template-filer**:
1. namespace.yaml
2. storageclass.yaml
3. mongodb-statefulset.yaml
4. mongodb-init-job.yaml
5. webapp-configmap.yaml
6. webapp-deployment.yaml
7. mongo-express-deployment.yaml

___

# 📄 Steg 8: Skapa Templates

---

## 📝 Template 1: namespace.yaml

### I VS Code:

1. **Högerklicka** på `helm-chart/todo-app-chart/templates/`-mappen
2. Välj **"New File"**
3. Namnge: `namespace.yaml`
4. **Klistra in:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
```

5. **Spara**

---

## 💡 Förklaring - Template syntax:

### Go template-syntax:

| Syntax | Vad det gör |
|--------|-------------|
| `{{ .Values.namespace }}` | Hämtar värde från values.yaml |
| `{{- include "todo-app.labels" . }}` | Anropar funktion från _helpers.tpl |
| `{{ nindent 4 }}` | Indenterar output 4 spaces |
| `{{-` | Tar bort whitespace före |
| `-}}` | Tar bort whitespace efter |

### Vad händer när Helm renderar:

**Template:**
```yaml
name: {{ .Values.namespace }}
```

**values.yaml:**
```yaml
namespace: todo-app
```

**Resultat:**
```yaml
name: todo-app
```

---

## 📝 Template 2: storageclass.yaml

1. **New File** → `storageclass.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.storageClass.enabled }}
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ .Values.storageClass.name }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
provisioner: {{ .Values.storageClass.provisioner }}
volumeBindingMode: {{ .Values.storageClass.volumeBindingMode }}
parameters:
  {{- toYaml .Values.storageClass.parameters | nindent 2 }}
{{- end }}
```

3. **Spara**

---

## 💡 Förklaring - Conditionals & toYaml:

### If-statement:
```yaml
{{- if .Values.storageClass.enabled }}
# Hela filen skapas ENDAST om enabled: true
{{- end }}
```

**values.yaml:**
```yaml
storageClass:
  enabled: false  # ← StorageClass skapas INTE
```

**values-eks-dockerhub.yaml:**
```yaml
storageClass:
  enabled: true   # ← StorageClass skapas!
```

### toYaml function:
```yaml
parameters:
  {{- toYaml .Values.storageClass.parameters | nindent 2 }}
```

**values.yaml:**
```yaml
storageClass:
  parameters:
    type: gp3
    encrypted: "true"
```

**Resultat:**
```yaml
parameters:
  type: gp3
  encrypted: "true"
```

**Varför toYaml?**
- Behåller YAML-struktur
- Hanterar nested objects automatiskt
- Ingen manuell formattering

---

## 📝 Template 3: mongodb-statefulset.yaml

**Denna är större - innehåller både Service och StatefulSet!**

1. **New File** → `mongodb-statefulset.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.mongodb.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  clusterIP: None
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb
spec:
  serviceName: mongodb-service
  replicas: {{ .Values.mongodb.replicas }}
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: {{ .Values.mongodb.image }}
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
        resources:
          {{- toYaml .Values.mongodb.resources | nindent 10 }}
  {{- if .Values.mongodb.storage.enabled }}
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: ["ReadWriteOnce"]
      {{- if .Values.mongodb.storage.storageClass }}
      storageClassName: {{ .Values.mongodb.storage.storageClass }}
      {{- end }}
      resources:
        requests:
          storage: {{ .Values.mongodb.storage.size }}
  {{- end }}
{{- end }}
```

3. **Spara**

---

## 💡 Förklaring - Nested conditionals:

### Yttre if:
```yaml
{{- if .Values.mongodb.enabled }}
# Hela MongoDB-resurser skapas endast om enabled: true
{{- end }}
```

### Inre if:
```yaml
{{- if .Values.mongodb.storage.enabled }}
volumeClaimTemplates:
  # PVC skapas endast om storage enabled
{{- end }}
```

### Nested if:
```yaml
{{- if .Values.mongodb.storage.storageClass }}
storageClassName: {{ .Values.mongodb.storage.storageClass }}
{{- end }}
```

**Logik:**
- Om `storageClass: ""` (tom string) → Sätts INTE
- Om `storageClass: "ebs-sc"` → `storageClassName: ebs-sc`

---

## 🎯 Tre templates klara!

```
templates/
├── _helpers.tpl                    ✅
├── namespace.yaml                  ✅
├── storageclass.yaml               ✅
└── mongodb-statefulset.yaml        ✅
```

**7 templates kvar!**

---

## 📝 Template 4: mongodb-init-job.yaml

1. **New File** → `mongodb-init-job.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.initJob.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "todo-app.fullname" . }}-mongodb-init
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb-init
spec:
  template:
    spec:
      containers:
      - name: mongo-init
        image: {{ .Values.mongodb.image }}
        command:
        - /bin/bash
        - -c
        - |
          sleep 10
          mongosh mongodb-service:27017/{{ .Values.mongodb.database }} --eval '
            db.TodoItems.insertMany([
              {{- range $index, $todo := .Values.initJob.todos }}
              {{- if $index }},{{ end }}
              {
                "Id": {{ $todo.id }},
                "Name": "{{ $todo.name }}",
                "IsComplete": {{ $todo.isComplete }}
              }
              {{- end }}
            ]);
            print("Database initialized successfully!");
          '          
      restartPolicy: OnFailure
  backoffLimit: {{ .Values.initJob.backoffLimit }}
{{- end }}
```

3. **Spara**

---

## 💡 Förklaring - Range (loops):

### Template loop:
```yaml
{{- range $index, $todo := .Values.initJob.todos }}
{
  "Id": {{ $todo.id }},
  "Name": "{{ $todo.name }}"
}
{{- end }}
```

**values.yaml:**
```yaml
initJob:
  todos:
    - id: 1
      name: "Learn Kubernetes"
    - id: 2
      name: "Deploy MongoDB"
```

**Resultat:**
```javascript
{
  "Id": 1,
  "Name": "Learn Kubernetes"
},
{
  "Id": 2,
  "Name": "Deploy MongoDB"
}
```

### Komma-hantering:
```yaml
{{- if $index }},{{ end }}
```

**Logik:**
- Första todo ($index = 0) → INGET komma
- Andra todo ($index = 1) → Komma före
- Tredje todo ($index = 2) → Komma före

**Perfekt JavaScript-array!** ✅

---

## 🎯 Fyra templates klara!

**3 kvar!** 

___

# 🚀 Fortsätter med fler templates!

---

## 📝 Template 5: webapp-configmap.yaml

1. **New File** → `webapp-configmap.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.webapp.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
data:
  MONGODB_HOST: "mongodb-service"
  MONGODB_PORT: "27017"
  MONGODB_DATABASE: {{ .Values.mongodb.database | quote }}
{{- end }}
```

3. **Spara**

---

## 💡 Förklaring - quote function:

```yaml
MONGODB_DATABASE: {{ .Values.mongodb.database | quote }}
```

**values.yaml:**
```yaml
mongodb:
  database: ToDoAppDb
```

**Resultat:**
```yaml
MONGODB_DATABASE: "ToDoAppDb"
```

**Varför quote?**
- Säkerställer att värdet är en string
- Undviker YAML-parsningsfel
- Best practice för environment-variabler

---

## 📝 Template 6: webapp-deployment.yaml

**Största templaten - både Service och Deployment!**

1. **New File** → `webapp-deployment.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.webapp.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: todo-webapp-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: todo-webapp
  {{- with .Values.webapp.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.webapp.service.type }}
  selector:
    app: todo-webapp
  ports:
  - port: {{ .Values.webapp.service.port }}
    targetPort: {{ .Values.webapp.port }}
    {{- if and (eq .Values.webapp.service.type "NodePort") .Values.webapp.service.nodePort }}
    nodePort: {{ .Values.webapp.service.nodePort }}
    {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-webapp
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: todo-webapp
spec:
  replicas: {{ .Values.webapp.replicas }}
  selector:
    matchLabels:
      app: todo-webapp
  template:
    metadata:
      labels:
        app: todo-webapp
    spec:
      containers:
      - name: webapp
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: {{ .Values.webapp.port }}
        envFrom:
        - configMapRef:
            name: webapp-config
        resources:
          {{- toYaml .Values.webapp.resources | nindent 10 }}
{{- end }}
```

3. **Spara**

---

## 💡 Förklaring - Advanced template features:

### 1. with-block (optional annotations):
```yaml
{{- with .Values.webapp.service.annotations }}
annotations:
  {{- toYaml . | nindent 4 }}
{{- end }}
```

**Logik:**
- Om `annotations: {}` (tom) → Hela blocket skippas
- Om `annotations: { key: value }` → Skapas

**values.yaml (default):**
```yaml
webapp:
  service:
    annotations: {}
```
**→ Inga annotations**

**values-eks-dockerhub.yaml:**
```yaml
webapp:
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```
**→ Annotations skapas!**

---

### 2. and + eq (logical operators):
```yaml
{{- if and (eq .Values.webapp.service.type "NodePort") .Values.webapp.service.nodePort }}
nodePort: {{ .Values.webapp.service.nodePort }}
{{- end }}
```

**Logik:**
- **and** = Båda villkoren måste vara sanna
- **eq** = Equality check

**Översatt:**
```
if (serviceType == "NodePort" AND nodePort != null) {
  nodePort: 30080
}
```

**values.yaml (default):**
```yaml
webapp:
  service:
    type: LoadBalancer  # ← INTE NodePort
    nodePort: null
```
**→ nodePort sätts INTE**

**values-docker-desktop.yaml (om vi hade den):**
```yaml
webapp:
  service:
    type: NodePort      # ← ÄR NodePort
    nodePort: 30080     # ← Inte null
```
**→ nodePort: 30080 skapas!**

---

### 3. String interpolation:
```yaml
image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
```

**values.yaml:**
```yaml
image:
  repository: norajami/todo-app
  tag: latest
```

**Resultat:**
```yaml
image: "norajami/todo-app:latest"
```

---

## 📝 Template 7: mongo-express-deployment.yaml (SISTA!)

1. **New File** → `mongo-express-deployment.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.mongoExpress.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongo-express
  {{- with .Values.mongoExpress.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.mongoExpress.service.type }}
  selector:
    app: mongo-express
  ports:
  - port: {{ .Values.mongoExpress.service.port }}
    targetPort: {{ .Values.mongoExpress.port }}
    {{- if and (eq .Values.mongoExpress.service.type "NodePort") .Values.mongoExpress.service.nodePort }}
    nodePort: {{ .Values.mongoExpress.service.nodePort }}
    {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongo-express
spec:
  replicas: {{ .Values.mongoExpress.replicas }}
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: {{ .Values.mongoExpress.image }}
        ports:
        - containerPort: {{ .Values.mongoExpress.port }}
        env:
        - name: ME_CONFIG_MONGODB_URL
          value: "mongodb://mongodb-service:27017"
        - name: ME_CONFIG_BASICAUTH_USERNAME
          value: {{ .Values.mongoExpress.username | quote }}
        - name: ME_CONFIG_BASICAUTH_PASSWORD
          value: {{ .Values.mongoExpress.password | quote }}
        resources:
          {{- toYaml .Values.mongoExpress.resources | nindent 10 }}
{{- end }}
```

3. **Spara**

---

## 🎉 ALLA TEMPLATES KLARA!

```
templates/
├── _helpers.tpl                      ✅
├── NOTES.txt
├── namespace.yaml                    ✅
├── storageclass.yaml                 ✅
├── mongodb-statefulset.yaml          ✅
├── mongodb-init-job.yaml             ✅
├── webapp-configmap.yaml             ✅
├── webapp-deployment.yaml            ✅
└── mongo-express-deployment.yaml     ✅
```

**7 templates skapade!** 🎊

---

## ✅ Hela Helm Chart-strukturen:

```
helm-chart/
└── todo-app-chart/
    ├── Chart.yaml                       ✅
    ├── values.yaml                      ✅
    ├── values-eks-dockerhub.yaml        ✅
    ├── charts/                          (tom, för dependencies)
    └── templates/
        ├── _helpers.tpl                 ✅
        ├── NOTES.txt                    (default, kan editeras)
        ├── namespace.yaml               ✅
        ├── storageclass.yaml            ✅
        ├── mongodb-statefulset.yaml     ✅
        ├── mongodb-init-job.yaml        ✅
        ├── webapp-configmap.yaml        ✅
        ├── webapp-deployment.yaml       ✅
        └── mongo-express-deployment.yaml ✅
```

---

## 🎯 Nästa steg: Validera och testa!

Nu ska vi:
1. ✅ **Lint** chartet (hitta fel)
2. ✅ **Preview** rendered templates
3. ✅ **Dry-run** install

___

# 🔍 Steg 9: Validera och Preview Helm Chart

---

## ✅ Steg 9.1: Lint Chart (Hitta fel)

**Lint = Statisk analys av Helm chart**

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart/todo-app-chart

helm lint .
```

**Förväntat output:**
```
==> Linting .
[INFO] Chart.yaml: icon is recommended

1 chart(s) linted, 0 chart(s) failed
```

**Vad linting kollar:**
- ✅ Chart.yaml är valid
- ✅ Templates har korrekt syntax
- ✅ Inga YAML-parsningsfel
- ✅ Inga felaktiga template-funktioner

**Om du får errors:**
- Kolla felmeddelandet noga
- Vanligt: Felaktig indentation i YAML
- Kolla vilket template som felar

---

## 💡 Vanliga lint-warnings (kan ignoreras):

**"icon is recommended"**
- Icon är en URL till en bild för chartet
- Valfritt, behövs ej för privata charts

**"keywords are recommended"**
- Vi har keywords, så denna kommer inte

**"home is recommended"**
- URL till projektets hemsida
- Valfritt

---

## 🔬 Steg 9.2: Preview Rendered Templates

**Se exakt vad Helm kommer deploya!**

### Preview med default values:

```bash
helm template my-todo-app . 
```

**Detta visar ALL YAML som kommer skapas.**

### Preview med EKS values:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml
```

**Output kommer vara lång!** Du ser:
- Namespace
- StorageClass (eftersom enabled: true i EKS)
- MongoDB StatefulSet
- MongoDB Service
- Init Job
- Webapp Deployment
- Webapp Service
- Mongo Express Deployment
- Mongo Express Service

---

## 🔎 Steg 9.3: Preview specifikt template

**Se bara ett template:**

```bash
# Bara webapp deployment
helm template my-todo-app . -f values-eks-dockerhub.yaml -s templates/webapp-deployment.yaml
```

**Användbart för:**
- Debugga specifikt template
- Se exakt hur variabler expanderar
- Verifiera logik (if/range/etc)

---

## 💾 Steg 9.4: Spara rendered output

**Bra för att inspektera offline:**

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml > rendered-eks.yaml
```

**Öppna sedan i VS Code:**
```bash
code rendered-eks.yaml
```

**Du ser:**
- All YAML som skulle deployats
- Inga `{{ }}` kvar
- Alla variabler ersatta
- Alla if-statements evaluerade

---

## 🧪 Steg 9.5: Dry-run (Simulera installation)

**Testa mot Kubernetes API utan att skapa resurser:**

```bash
helm install my-todo-app . -f values-eks-dockerhub.yaml --dry-run --debug
```

**Vad detta gör:**
- ✅ Renderar templates
- ✅ Validerar mot Kubernetes API
- ✅ Kollar om resurser kan skapas
- ❌ Skapar INTE resurserna

**Output visar:**
```yaml
---
# Source: todo-app-chart/templates/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: todo-app
  labels:
    helm.sh/chart: todo-app-1.0.0
    app.kubernetes.io/name: todo-app
    ...
---
# Source: todo-app-chart/templates/storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
...
```

---

## 🔍 Steg 9.6: Verifiera viktiga delar

### Kolla att image är rätt:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep "image:"
```

**Förväntat:**
```yaml
        image: "norajami/todo-app:latest"
        image: mongo:latest
        image: mongo:latest
        image: mongo-express:latest
```

✅ **Ditt Docker Hub-namn ska synas!**

---

### Kolla att StorageClass skapas för EKS:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep -A 5 "kind: StorageClass"
```

**Förväntat:**
```yaml
kind: StorageClass
metadata:
  name: ebs-sc
  labels:
    helm.sh/chart: todo-app-1.0.0
provisioner: ebs.csi.eks.amazonaws.com
```

✅ **EBS StorageClass finns!**

---

### Kolla att LoadBalancer annotations finns:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep -A 2 "annotations:"
```

**Förväntat:**
```yaml
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

✅ **AWS annotations finns!**

---

### Kolla att replicas är rätt:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep "replicas:"
```

**Förväntat:**
```yaml
  replicas: 1    # MongoDB
  replicas: 2    # WebApp
  replicas: 1    # Mongo Express
```

✅ **Replicas matchar values.yaml!**

---

## 🎯 Steg 9.7: Testa --set overrides

**Ändra värden via CLI utan att redigera filer:**

```bash
helm template my-todo-app . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=5 \
  --set mongoExpress.enabled=false \
  | grep -E "replicas:|kind: Deployment" 
```

**Förväntat:**
```yaml
kind: Deployment
  replicas: 1    # MongoDB
kind: Deployment
  replicas: 5    # WebApp (ändrat från 2!)
# Mongo Express deployment saknas helt (enabled=false)
```

**Detta visar Helm's flexibilitet!** ✨

---

## ✅ Validering klar!

**Om alla kommandon fungerade:**
- ✅ Chart är syntaktiskt korrekt
- ✅ Templates renderar korrekt
- ✅ Variabler expanderar som förväntat
- ✅ Conditionals fungerar
- ✅ Loops fungerar

---

## 📊 Sammanfattning - Validerings-kommandon:

```bash
# 1. Lint
helm lint .

# 2. Preview alla templates
helm template my-todo-app . -f values-eks-dockerhub.yaml

# 3. Preview specifikt template
helm template my-todo-app . -s templates/webapp-deployment.yaml

# 4. Dry-run
helm install my-todo-app . -f values-eks-dockerhub.yaml --dry-run

# 5. Spara rendered YAML
helm template my-todo-app . -f values-eks-dockerhub.yaml > rendered.yaml

# 6. Testa CLI overrides
helm template my-todo-app . --set webapp.replicas=5
```

---

# 🚀 Steg 10: Deployment-kommandon 

---

## 📝 Deployment Guide

### 🔄 Förberedelser (om du har EKS-cluster)

```bash
# 1. Verifiera att kubectl är anslutet till EKS
kubectl cluster-info

# 2. Kolla att du är i rätt context
kubectl config current-context

# 3. Verifiera att Docker image finns på Docker Hub
# Gå till: https://hub.docker.com/r/norajami/todo-app
```

---

## 🚀 Steg 10.1: Install Chart till EKS

### Install kommando:

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart/todo-app-chart

helm install todo-app-eks . -f values-eks-dockerhub.yaml
```

**Förväntat output:**
```
NAME: todo-app-eks
LAST DEPLOYED: 2025-10-14 13:00:00
NAMESPACE: default
STATUS: deployed
REVISION: 1
```

**Vad händer:**
1. Helm läser `values.yaml` (defaults)
2. Mergar med `values-eks-dockerhub.yaml` (overrides)
3. Renderar alla templates
4. Applicerar till Kubernetes
5. Sparar release-info

---

## 👀 Steg 10.2: Övervaka Deployment

### Lista alla Helm releases:

```bash
helm list
```

**Output:**
```
NAME            NAMESPACE  REVISION  STATUS    CHART           APP VERSION
todo-app-eks    default    1         deployed  todo-app-1.0.0  1.0.0
```

---

### Kolla release status:

```bash
helm status todo-app-eks
```

**Output:**
```
NAME: todo-app-eks
LAST DEPLOYED: ...
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

---

### Kolla Kubernetes-resurser:

```bash
# Alla resurser i namespace
kubectl get all -n todo-app

# Pods
kubectl get pods -n todo-app -w

# Services
kubectl get svc -n todo-app

# PVC
kubectl get pvc -n todo-app

# StorageClass
kubectl get storageclass ebs-sc
```

---

### Vänta på pods:

```bash
# MongoDB
kubectl wait --for=condition=ready pod -l app=mongodb -n todo-app --timeout=300s

# WebApp
kubectl wait --for=condition=ready pod -l app=todo-webapp -n todo-app --timeout=180s

# Mongo Express
kubectl wait --for=condition=ready pod -l app=mongo-express -n todo-app --timeout=180s
```

---

## 🌐 Steg 10.3: Få Load Balancer-URL:er

### WebApp URL:

```bash
kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
```

**Eller:**
```bash
WEBAPP_URL=$(kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
echo "Todo App: http://${WEBAPP_URL}"
```

---

### Mongo Express URL:

```bash
MONGO_EXPRESS_URL=$(kubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
echo "Mongo Express: http://${MONGO_EXPRESS_URL}"
```

---

### Testa API:

```bash
curl http://${WEBAPP_URL}/api/todos
```

**Förväntat:**
```json
[
  {"id":1,"name":"Learn Kubernetes","isComplete":false},
  {"id":2,"name":"Deploy MongoDB","isComplete":true}
]
```

---

## 🔄 Steg 10.4: Upgrade Release

**Scenario: Du vill ändra något (t.ex. fler replicas)**

### Alternativ A: Editera values-fil och upgrade

```bash
# Editera values-eks-dockerhub.yaml
# Ändra webapp.replicas från 2 till 3

helm upgrade todo-app-eks . -f values-eks-dockerhub.yaml
```

---

### Alternativ B: Override via CLI

```bash
helm upgrade todo-app-eks . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=3
```

**Förväntat output:**
```
Release "todo-app-eks" has been upgraded. Happy Helming!
NAME: todo-app-eks
LAST DEPLOYED: 2025-10-14 13:15:00
NAMESPACE: default
STATUS: deployed
REVISION: 2
```

**Notera:** REVISION ökade från 1 → 2!

---

### Verifiera upgrade:

```bash
# Kolla att 3 webapp-pods körs
kubectl get pods -n todo-app -l app=todo-webapp

# Se vad som ändrades
helm diff revision todo-app-eks 1 2
# (Kräver helm-diff plugin)
```

---

## 📜 Steg 10.5: Release History

### Se alla revisions:

```bash
helm history todo-app-eks
```

**Output:**
```
REVISION  UPDATED                   STATUS      CHART           DESCRIPTION
1         Mon Oct 14 13:00:00 2025  superseded  todo-app-1.0.0  Install complete
2         Mon Oct 14 13:15:00 2025  deployed    todo-app-1.0.0  Upgrade complete
```

---

### Se vilka values som användes i revision:

```bash
# Current revision
helm get values todo-app-eks

# Specifik revision
helm get values todo-app-eks --revision 1

# Alla values (inklusive defaults)
helm get values todo-app-eks --all
```

---

### Se manifest för en revision:

```bash
helm get manifest todo-app-eks --revision 1
```

**Visar exakt YAML som deployades i revision 1.**

---

## ⏮️ Steg 10.6: Rollback

**Scenario: Upgrade gick fel, du vill gå tillbaka!**

### Rollback till föregående revision:

```bash
helm rollback todo-app-eks
```

**Går tillbaka till revision 1** (2 replicas)

---

### Rollback till specifik revision:

```bash
helm rollback todo-app-eks 1
```

**Förväntat output:**
```
Rollback was a success! Happy Helming!
```

---

### Verifiera rollback:

```bash
# Kolla history
helm history todo-app-eks

# Output:
REVISION  UPDATED                   STATUS      CHART           DESCRIPTION
1         Mon Oct 14 13:00:00 2025  superseded  todo-app-1.0.0  Install complete
2         Mon Oct 14 13:15:00 2025  superseded  todo-app-1.0.0  Upgrade complete
3         Mon Oct 14 13:20:00 2025  deployed    todo-app-1.0.0  Rollback to 1
```

**Notera:** Rollback skapar ny revision (3), som är kopia av revision 1!

---

## 🗑️ Steg 10.7: Uninstall Release

### Ta bort release:

```bash
helm uninstall todo-app-eks
```

**Förväntat output:**
```
release "todo-app-eks" uninstalled
```

**Vad som händer:**
- ✅ Alla Kubernetes-resurser raderas
- ✅ Namespace raderas
- ✅ PVCs raderas (MongoDB data förloras!)
- ✅ LoadBalancers raderas
- ❌ History sparas (kan fortfarande ses)

---

### Verifiera att allt är borta:

```bash
# Kolla att release är borta
helm list

# Kolla att resurser är borta
kubectl get all -n todo-app
# Output: Error from server (NotFound): namespaces "todo-app" not found

# Kolla att StorageClass finns kvar (kan användas av andra apps)
kubectl get storageclass ebs-sc
```

---

### Uninstall med --keep-history:

```bash
helm uninstall todo-app-eks --keep-history
```

**Skillnad:** History sparas, kan inte re-deploya med samma namn förrän du rensar history.

---

## 🎛️ Steg 10.8: Advanced - CLI Overrides

**Ändra flera värden samtidigt:**

```bash
helm install todo-app-eks . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=5 \
  --set mongoExpress.enabled=false \
  --set mongodb.storage.size=2Gi \
  --set image.tag=v2.0.0
```

**Detta overridar:**
- WebApp replicas: 2 → 5
- Mongo Express: Stängs av helt
- MongoDB storage: 1Gi → 2Gi
- Image tag: latest → v2.0.0

---

## 📦 Steg 10.9: Package Chart (Optional)

**Skapa .tgz-fil för distribution:**

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart

helm package todo-app-chart
```

**Output:**
```
Successfully packaged chart and saved it to: /path/to/todo-app-1.0.0.tgz
```

**Användning:**
- Dela med andra
- Ladda upp till Helm repository
- Version control av chart-paket

---

### Install från package:

```bash
helm install todo-app-eks todo-app-1.0.0.tgz -f values-eks-dockerhub.yaml
```

---

## 🔍 Steg 10.10: Troubleshooting-kommandon

### Pod startar inte:

```bash
# Kolla pod status
kubectl get pods -n todo-app

# Describe pod
kubectl describe pod <pod-name> -n todo-app

# Se loggar
kubectl logs <pod-name> -n todo-app

# Se events
kubectl get events -n todo-app --sort-by='.lastTimestamp'
```

---

### LoadBalancer fastnar på pending:

```bash
# Describe service
kubectl describe svc todo-webapp-service -n todo-app

# Kolla Load Balancer i AWS Console
# EC2 → Load Balancers
```

---

### Helm release fastnat:

```bash
# Se Helm release status
helm status todo-app-eks

# Force delete
helm uninstall todo-app-eks --no-hooks

# Cleanup Kubernetes resources manually
kubectl delete namespace todo-app --force --grace-period=0
```

---

## 📋 Sammanfattning - Alla Helm-kommandon:

```bash
# INSTALLATION
helm install <name> . -f values.yaml
helm install <name> . --dry-run --debug

# UPGRADE
helm upgrade <name> . -f values.yaml
helm upgrade <name> . --set key=value

# ROLLBACK
helm rollback <name>
helm rollback <name> <revision>

# INFORMATION
helm list
helm status <name>
helm history <name>
helm get values <name>
helm get manifest <name>

# UNINSTALL
helm uninstall <name>
helm uninstall <name> --keep-history

# VALIDATION
helm lint .
helm template <name> .
helm template <name> . -f values.yaml

# PACKAGING
helm package .
```

---
