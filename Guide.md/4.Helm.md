# **Helm**! 

---

## üìä Tutorial 4 - Snabb √∂versikt

**Helm vs Kustomize:**
- **Kustomize** (Tutorial 3): Patches och overlays
- **Helm** (Tutorial 4): Templates med variabler ‚Üí Mer kraftfullt!

---

## ‚ö†Ô∏è VIKTIGT: Rensa f√∂rst!

Innan vi b√∂rjar med Helm m√•ste vi **radera** Kustomize-deploymenten fr√•n EKS (annars kommer de krocka - samma namespace och resurser!)

### Radera fr√•n EKS:

```bash
cd ~/AWS-Kubernetes/todo-app

kubectl delete -k kubernetes/overlays/eks-dockerhub
```

**F√∂rv√§ntat:**
```
namespace "todo-app" deleted
storageclass "ebs-sc" deleted
service "mongodb-service" deleted
statefulset "mongodb" deleted
...
```

### Verifiera att allt √§r borta:

```bash
kubectl get all -n todo-app
```

**F√∂rv√§ntat:**
```
No resources found in todo-app namespace.
```

**Eller:**
```
Error from server (NotFound): namespaces "todo-app" not found
```

B√•da √§r OK! ‚úÖ

---

## üõ†Ô∏è Installera Helm (om du inte har det)

```bash
helm version
```

**Om du f√•r version:** Du har det redan! ‚úÖ

**Om "command not found":**

**Windows (med Chocolatey):**
```bash
choco install kubernetes-helm
```

**Eller ladda ner manuellt:**
1. G√• till: https://github.com/helm/helm/releases
2. Ladda ner `helm-v3.x.x-windows-amd64.zip`
3. Extrahera `helm.exe` till `C:\Program Files\helm\`
4. L√§gg till i PATH
5. Starta om Terminal

---

## üìÅ Steg 1: Skapa Helm Chart-struktur

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa ny mapp f√∂r Helm
mkdir helm-chart
cd helm-chart

# Skapa Helm chart (genererar grundstruktur)
helm create todo-app-chart
```

**Detta skapar:**
```
helm-chart/
‚îî‚îÄ‚îÄ todo-app-chart/
    ‚îú‚îÄ‚îÄ Chart.yaml
    ‚îú‚îÄ‚îÄ values.yaml
    ‚îú‚îÄ‚îÄ charts/
    ‚îî‚îÄ‚îÄ templates/
        ‚îú‚îÄ‚îÄ deployment.yaml
        ‚îú‚îÄ‚îÄ service.yaml
        ‚îî‚îÄ‚îÄ ...
```

### Rensa bort defaults:

```bash
cd todo-app-chart

# Ta bort default templates (vi skapar egna)
rm -rf templates/*.yaml templates/tests
```

---

## üìã Nu ska vi skapa flera filer!

**Vi beh√∂ver skapa:**
1. ‚úÖ `Chart.yaml` (metadata)
2. ‚úÖ `values.yaml` (default config)
3. ‚úÖ `values-eks-dockerhub.yaml` (EKS-specifik config)
4. ‚úÖ 10 template-filer (i templates/)

**Detta √§r mer √§n Tutorial 3, men mer kraftfullt!**

---

## üíª √ñppna VS Code

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

---

AWS-Kubernetes/
‚îú‚îÄ‚îÄ todo-app/
‚îÇ   ‚îú‚îÄ‚îÄ kubernetes/          (Kustomize - Tutorial 3) ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ helm-chart/          (Helm - Tutorial 4) ‚Üê NY!
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ todo-app-chart/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Chart.yaml
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ values.yaml
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ values-eks-dockerhub.yaml
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ _helpers.tpl
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ namespace.yaml
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ mongodb-statefulset.yaml
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ ... (10 filer)
‚îÇ   ‚îî‚îÄ‚îÄ ...

___

# üöÄ Perfekt! Steg-f√∂r-steg Helm Tutorial 4!

Vi skapar allting fr√•n grunden med f√∂rklaringar!

---

## üìÅ Steg 1: Skapa Helm-struktur

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app

# Skapa mapp f√∂r Helm
mkdir helm-chart
cd helm-chart

# Skapa Helm chart med default struktur
helm create todo-app-chart
```

**Vad h√§nder:**
- `helm create` genererar en grundstruktur
- Vi f√•r templates, values.yaml, Chart.yaml automatiskt
- Men vi kommer ers√§tta allt inneh√•ll!

### Verifiera:

```bash
ls todo-app-chart/
```

**Du ska se:**
```
Chart.yaml
charts/
templates/
values.yaml
```

---

## üßπ Steg 2: Rensa default-filer

Vi vill skapa v√•ra egna templates fr√•n scratch!

```bash
cd todo-app-chart

# Ta bort alla default templates
rm templates/*.yaml
rm -rf templates/tests

# Beh√•ll bara _helpers.tpl (vi uppdaterar den senare)
```

### Verifiera:

```bash
ls templates/
```

**Ska endast visa:**
```
_helpers.tpl
NOTES.txt
```

---

## üíª Steg 3: √ñppna i VS Code

```bash
cd ~/AWS-Kubernetes/todo-app
code .
```

**I VS Code sidopanel ska du se:**
```
todo-app/
‚îú‚îÄ‚îÄ helm-chart/
‚îÇ   ‚îî‚îÄ‚îÄ todo-app-chart/
‚îÇ       ‚îú‚îÄ‚îÄ Chart.yaml
‚îÇ       ‚îú‚îÄ‚îÄ charts/
‚îÇ       ‚îú‚îÄ‚îÄ templates/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ _helpers.tpl
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ NOTES.txt
‚îÇ       ‚îî‚îÄ‚îÄ values.yaml
‚îú‚îÄ‚îÄ kubernetes/         (Kustomize fr√•n Tutorial 3)
‚îú‚îÄ‚îÄ webapp/
‚îî‚îÄ‚îÄ ...
```

---

## üìÑ Steg 4: Skapa Chart.yaml (Metadata)

### I VS Code:

1. **√ñppna** `helm-chart/todo-app-chart/Chart.yaml`
2. **Radera allt** som finns d√§r
3. **Klistra in:**

```yaml
apiVersion: v2
name: todo-app
description: A full-stack Todo application with MongoDB backend
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - todo
  - mongodb
  - asp.net
  - kubernetes
maintainers:
  - name: norajami
    email: norajami@gmail.com
```

4. **Spara** (Ctrl+S)

---

## üí° F√∂rklaring - Chart.yaml:

| F√§lt | Vad det betyder |
|------|-----------------|
| `apiVersion: v2` | Helm 3 format |
| `name` | Chart-namnet (anv√§nds i kommandon) |
| `description` | Kort beskrivning av appen |
| `type: application` | Deployable app (vs "library") |
| `version` | Chart-version (√∂kas vid √§ndringar) |
| `appVersion` | Din applikations version |
| `keywords` | F√∂r s√∂kning i Helm repos |
| `maintainers` | Vem som underh√•ller chartet |

**Skillnad fr√•n Kustomize:** 
- Kustomize har ingen metadata-fil
- Helm charts √§r "paket" som kan delas och versionshanteras

---

## üìù Steg 5: Skapa _helpers.tpl (Template-funktioner)

### I VS Code:

1. **√ñppna** `helm-chart/todo-app-chart/templates/_helpers.tpl`
2. **Radera allt**
3. **Klistra in:**

```go
{{/*
Expand the name of the chart.
*/}}
{{- define "todo-app.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
*/}}
{{- define "todo-app.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "todo-app.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
app.kubernetes.io/name: {{ include "todo-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "todo-app.selectorLabels" -}}
app.kubernetes.io/name: {{ include "todo-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}
```

4. **Spara**

---

## üí° F√∂rklaring - _helpers.tpl:

**Vad √§r detta?**
- √Öteranv√§ndbara template-funktioner
- Definieras en g√•ng, anv√§nds √∂verallt
- Go template-syntax

**Funktionerna:**

| Funktion | Vad den g√∂r |
|----------|-------------|
| `todo-app.name` | Genererar app-namn (max 63 tecken) |
| `todo-app.fullname` | Fullst√§ndigt namn inklusive release |
| `todo-app.labels` | Standard Kubernetes-labels |
| `todo-app.selectorLabels` | Labels f√∂r selectors |

**Exempel anv√§ndning:**
```yaml
metadata:
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
```

**Skillnad fr√•n Kustomize:**
- Kustomize: Inga funktioner, ren YAML
- Helm: Kraftfulla template-funktioner med logik

---

## üéØ N√§sta: values.yaml (Default-konfiguration)

**Detta √§r HJ√ÑRTAT i Helm!** 

H√§r definierar vi alla variabler som templates anv√§nder.

___

# üìã Steg 6: Skapa values.yaml (Default-konfiguration)

Detta √§r **hj√§rtat** i Helm - alla variabler definieras h√§r!

---

## üìù I VS Code:

1. **√ñppna** `helm-chart/todo-app-chart/values.yaml`
2. **Radera allt** som finns d√§r
3. **Klistra in:**

```yaml
# Default values for todo-app chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
namespace: todo-app

# Container image configuration
image:
  repository: norajami/todo-app
  tag: latest
  pullPolicy: Always

# MongoDB configuration
mongodb:
  enabled: true
  replicas: 1
  image: mongo:latest
  storage:
    enabled: true
    size: 1Gi
    # storageClass will be set per environment
    storageClass: ""
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  database: "ToDoAppDb"

# WebApp configuration
webapp:
  enabled: true
  replicas: 2
  port: 8080
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  service:
    type: LoadBalancer
    port: 80
    # NodePort for Docker Desktop (optional)
    nodePort: null
    # AWS Load Balancer annotations (only for EKS)
    annotations: {}

# Mongo Express configuration
mongoExpress:
  enabled: true
  replicas: 1
  image: mongo-express:latest
  port: 8081
  username: admin
  password: pass
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  service:
    type: LoadBalancer
    port: 80
    nodePort: null
    annotations: {}

# Init job configuration
initJob:
  enabled: true
  backoffLimit: 4
  todos:
    - id: 1
      name: "Learn Kubernetes"
      isComplete: false
    - id: 2
      name: "Deploy MongoDB"
      isComplete: true

# Storage class (environment-specific)
storageClass:
  enabled: false
  name: ebs-sc
  provisioner: ebs.csi.eks.amazonaws.com
  volumeBindingMode: WaitForFirstConsumer
  parameters:
    type: gp3
    encrypted: "true"
```

4. **Spara** (Ctrl+S)

---

## üí° F√∂rklaring - values.yaml struktur:

### üîß Varf√∂r √§r detta kraftfullt?

**Kustomize:**
```yaml
# M√•ste patcha varje fil separat
patches:
  - target: Deployment
    patch: change replicas
```

**Helm:**
```yaml
# En variabel √§ndrar allt
webapp:
  replicas: 2  # ‚Üê √Ñndra h√§r, appliceras √∂verallt
```

---

### üìä Viktiga sektioner:

#### 1. **Image configuration**
```yaml
image:
  repository: norajami/todo-app  # ‚Üê Ditt Docker Hub-namn!
  tag: latest
  pullPolicy: Always
```

**Anv√§nds i:** `webapp-deployment.yaml` template  
**G√∂r att:** L√§tt byta image utan att redigera templates

---

#### 2. **MongoDB configuration**
```yaml
mongodb:
  enabled: true      # ‚Üê On/off switch!
  replicas: 1
  storage:
    storageClass: "" # ‚Üê Tomt = s√§tts per milj√∂
```

**Enabled-flaggor:**
- `enabled: false` ‚Üí Hela MongoDB-resurser skippas
- Perfekt f√∂r dev-milj√∂er utan databas

---

#### 3. **Resources (CPU/Memory)**
```yaml
resources:
  requests:
    memory: "256Mi"  # Minsta garanterade
    cpu: "250m"      # 0.25 CPU cores
  limits:
    memory: "512Mi"  # Max till√•tet
    cpu: "500m"
```

**Kubernetes anv√§nder detta f√∂r:**
- Scheduling (vilken node passar?)
- Resource quota enforcement
- OOMKill om limit √∂verskrids

---

#### 4. **Service configuration**
```yaml
service:
  type: LoadBalancer  # √Ñndras till NodePort f√∂r lokal
  port: 80
  nodePort: null      # S√§tts f√∂r Docker Desktop
  annotations: {}     # AWS-specifika f√∂r EKS
```

**Dynamiskt!**
- Docker Desktop: NodePort + nodePort: 30080
- EKS: LoadBalancer + AWS annotations

---

#### 5. **Init Job todos (list/array)**
```yaml
initJob:
  todos:
    - id: 1
      name: "Learn Kubernetes"
    - id: 2
      name: "Deploy MongoDB"
```

**Template kommer loopa √∂ver denna array!**  
L√§gg till fler todos ‚Üí automatiskt i databasen

---

#### 6. **StorageClass (conditional)**
```yaml
storageClass:
  enabled: false  # ‚Üê Docker Desktop beh√∂ver inte, EKS g√∂r det
```

**If-statement i template:**
```yaml
{{- if .Values.storageClass.enabled }}
# Skapa StorageClass
{{- end }}
```

---

## üÜö J√§mf√∂relse: Kustomize vs Helm

### Samma uppgift: √Ñndra replicas

**Kustomize:**
```yaml
# kustomization.yaml
patches:
  - target:
      kind: Deployment
      name: todo-webapp
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
```

**Helm:**
```yaml
# values.yaml
webapp:
  replicas: 5
```

**Eller vid deploy:**
```bash
helm install todo-app . --set webapp.replicas=5
```

---

### Samma uppgift: St√§ng av Mongo Express

**Kustomize:**
```yaml
# M√•ste kommentera bort i kustomization.yaml
resources:
  # - mongo-express-deployment.yaml  # Commented out
```

**Helm:**
```yaml
# values.yaml
mongoExpress:
  enabled: false
```

**Eller vid deploy:**
```bash
helm install todo-app . --set mongoExpress.enabled=false
```

---

## üéØ Nyckelpunkter:

‚úÖ **values.yaml = Central konfiguration**  
‚úÖ **Alla templates l√§ser h√§rifr√•n**  
‚úÖ **L√§tt att overrida per milj√∂**  
‚úÖ **Kan √§ndras via CLI (--set)**  
‚úÖ **Strukturerat och l√§sbart**

---

## üìÇ N√§sta: Environment-specifika values

Vi skapar:
- `values-eks-dockerhub.yaml` - F√∂r EKS med Docker Hub

___


# üåç Steg 7: Skapa Environment-specifik Values

Nu skapar vi override-fil f√∂r **EKS med Docker Hub**!

---

## üìù I VS Code:

1. **H√∂gerklicka** p√• `helm-chart/todo-app-chart/`-mappen
2. V√§lj **"New File"**
3. Namnge: `values-eks-dockerhub.yaml`
4. **Klistra in:**

```yaml
# EKS environment with Docker Hub image
# This file overrides values.yaml for EKS deployments

# Use Docker Hub image (same as default, but explicit)
image:
  repository: norajami/todo-app
  tag: latest

# MongoDB storage - use EBS
mongodb:
  storage:
    storageClass: ebs-sc

# WebApp service - LoadBalancer with AWS annotations
webapp:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

# Mongo Express service - LoadBalancer with AWS annotations
mongoExpress:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

# Create EBS StorageClass
storageClass:
  enabled: true
  name: ebs-sc
  provisioner: ebs.csi.eks.amazonaws.com
  volumeBindingMode: WaitForFirstConsumer
  parameters:
    type: gp3
    encrypted: "true"
```

5. **Spara** (Ctrl+S)

---

## üí° F√∂rklaring - Environment overrides:

### üîÑ Hur Helm kombinerar values:

**N√§r du k√∂r:**
```bash
helm install todo-app . -f values-eks-dockerhub.yaml
```

**Helm g√∂r:**
1. L√§ser `values.yaml` (defaults)
2. L√§ser `values-eks-dockerhub.yaml` (overrides)
3. **Mergar** dem (senare filer vinner)

---

### üìä Vad h√§nder i praktiken:

**values.yaml s√§ger:**
```yaml
webapp:
  service:
    type: LoadBalancer
    annotations: {}  # Tom
```

**values-eks-dockerhub.yaml s√§ger:**
```yaml
webapp:
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

**Resultat:**
```yaml
webapp:
  service:
    type: LoadBalancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

---

### üîë Nyckeldifferenser f√∂r EKS:

| Setting | Default (values.yaml) | EKS override |
|---------|----------------------|--------------|
| `storageClass.enabled` | `false` | `true` ‚úÖ |
| `mongodb.storage.storageClass` | `""` | `ebs-sc` ‚úÖ |
| `webapp.service.annotations` | `{}` | AWS internet-facing ‚úÖ |
| `mongoExpress.service.annotations` | `{}` | AWS internet-facing ‚úÖ |

---

### üåê Docker Desktop vs EKS - Side by side:

**Om vi hade skapat `values-docker-desktop.yaml`:**

```yaml
# Docker Desktop environment
image:
  repository: norajami/todo-app

mongodb:
  storage:
    storageClass: hostpath  # ‚Üê Lokal storage

webapp:
  service:
    type: NodePort          # ‚Üê Inte LoadBalancer
    nodePort: 30080         # ‚Üê Fixed port

mongoExpress:
  service:
    type: NodePort
    nodePort: 30081

storageClass:
  enabled: false            # ‚Üê Anv√§nd inbyggd
```

**J√§mf√∂rt med EKS:**

```yaml
# EKS environment
mongodb:
  storage:
    storageClass: ebs-sc    # ‚Üê AWS EBS

webapp:
  service:
    type: LoadBalancer      # ‚Üê AWS ELB
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

storageClass:
  enabled: true             # ‚Üê Skapa EBS StorageClass
```

---

## üéØ F√∂rdelar med denna approach:

‚úÖ **En kodbas** - Samma templates f√∂r alla milj√∂er  
‚úÖ **Minimal duplication** - Endast skillnader i values-filer  
‚úÖ **L√§tt att j√§mf√∂ra** - Se exakt vad som skiljer milj√∂er  
‚úÖ **S√§ker** - Kan inte r√•ka deploya fel config  
‚úÖ **Skalbar** - L√§gg till `values-prod.yaml`, `values-staging.yaml`

---

## üÜö Kustomize vs Helm - Environments:

**Kustomize:**
```
overlays/
‚îú‚îÄ‚îÄ docker-desktop/
‚îÇ   ‚îú‚îÄ‚îÄ kustomization.yaml        (15 rader patches)
‚îÇ   ‚îú‚îÄ‚îÄ webapp-service-patch.yaml (10 rader)
‚îÇ   ‚îî‚îÄ‚îÄ storage-patch.yaml        (8 rader)
‚îî‚îÄ‚îÄ eks-dockerhub/
    ‚îú‚îÄ‚îÄ kustomization.yaml        (20 rader patches)
    ‚îî‚îÄ‚îÄ storageclass.yaml         (10 rader)
```
**= 63 rader totalt**

**Helm:**
```
values-docker-desktop.yaml  (15 rader)
values-eks-dockerhub.yaml   (20 rader)
```
**= 35 rader totalt**

**Och mer l√§sbart!** ‚ú®

---

## üìÇ Struktur hittills:

```
helm-chart/
‚îî‚îÄ‚îÄ todo-app-chart/
    ‚îú‚îÄ‚îÄ Chart.yaml                      ‚úÖ
    ‚îú‚îÄ‚îÄ values.yaml                     ‚úÖ
    ‚îú‚îÄ‚îÄ values-eks-dockerhub.yaml       ‚úÖ
    ‚îî‚îÄ‚îÄ templates/
        ‚îú‚îÄ‚îÄ _helpers.tpl                ‚úÖ
        ‚îî‚îÄ‚îÄ NOTES.txt
```

---

## üéØ N√§sta: Skapa Templates!

Nu b√∂rjar det roliga - vi skapar **templated Kubernetes manifests**!

Vi ska skapa **10 template-filer**:
1. namespace.yaml
2. storageclass.yaml
3. mongodb-statefulset.yaml
4. mongodb-init-job.yaml
5. webapp-configmap.yaml
6. webapp-deployment.yaml
7. mongo-express-deployment.yaml

___

# üìÑ Steg 8: Skapa Templates

---

## üìù Template 1: namespace.yaml

### I VS Code:

1. **H√∂gerklicka** p√• `helm-chart/todo-app-chart/templates/`-mappen
2. V√§lj **"New File"**
3. Namnge: `namespace.yaml`
4. **Klistra in:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
```

5. **Spara**

---

## üí° F√∂rklaring - Template syntax:

### Go template-syntax:

| Syntax | Vad det g√∂r |
|--------|-------------|
| `{{ .Values.namespace }}` | H√§mtar v√§rde fr√•n values.yaml |
| `{{- include "todo-app.labels" . }}` | Anropar funktion fr√•n _helpers.tpl |
| `{{ nindent 4 }}` | Indenterar output 4 spaces |
| `{{-` | Tar bort whitespace f√∂re |
| `-}}` | Tar bort whitespace efter |

### Vad h√§nder n√§r Helm renderar:

**Template:**
```yaml
name: {{ .Values.namespace }}
```

**values.yaml:**
```yaml
namespace: todo-app
```

**Resultat:**
```yaml
name: todo-app
```

---

## üìù Template 2: storageclass.yaml

1. **New File** ‚Üí `storageclass.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.storageClass.enabled }}
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ .Values.storageClass.name }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
provisioner: {{ .Values.storageClass.provisioner }}
volumeBindingMode: {{ .Values.storageClass.volumeBindingMode }}
parameters:
  {{- toYaml .Values.storageClass.parameters | nindent 2 }}
{{- end }}
```

3. **Spara**

---

## üí° F√∂rklaring - Conditionals & toYaml:

### If-statement:
```yaml
{{- if .Values.storageClass.enabled }}
# Hela filen skapas ENDAST om enabled: true
{{- end }}
```

**values.yaml:**
```yaml
storageClass:
  enabled: false  # ‚Üê StorageClass skapas INTE
```

**values-eks-dockerhub.yaml:**
```yaml
storageClass:
  enabled: true   # ‚Üê StorageClass skapas!
```

### toYaml function:
```yaml
parameters:
  {{- toYaml .Values.storageClass.parameters | nindent 2 }}
```

**values.yaml:**
```yaml
storageClass:
  parameters:
    type: gp3
    encrypted: "true"
```

**Resultat:**
```yaml
parameters:
  type: gp3
  encrypted: "true"
```

**Varf√∂r toYaml?**
- Beh√•ller YAML-struktur
- Hanterar nested objects automatiskt
- Ingen manuell formattering

---

## üìù Template 3: mongodb-statefulset.yaml

**Denna √§r st√∂rre - inneh√•ller b√•de Service och StatefulSet!**

1. **New File** ‚Üí `mongodb-statefulset.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.mongodb.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  clusterIP: None
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb
spec:
  serviceName: mongodb-service
  replicas: {{ .Values.mongodb.replicas }}
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: {{ .Values.mongodb.image }}
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-data
          mountPath: /data/db
        resources:
          {{- toYaml .Values.mongodb.resources | nindent 10 }}
  {{- if .Values.mongodb.storage.enabled }}
  volumeClaimTemplates:
  - metadata:
      name: mongodb-data
    spec:
      accessModes: ["ReadWriteOnce"]
      {{- if .Values.mongodb.storage.storageClass }}
      storageClassName: {{ .Values.mongodb.storage.storageClass }}
      {{- end }}
      resources:
        requests:
          storage: {{ .Values.mongodb.storage.size }}
  {{- end }}
{{- end }}
```

3. **Spara**

---

## üí° F√∂rklaring - Nested conditionals:

### Yttre if:
```yaml
{{- if .Values.mongodb.enabled }}
# Hela MongoDB-resurser skapas endast om enabled: true
{{- end }}
```

### Inre if:
```yaml
{{- if .Values.mongodb.storage.enabled }}
volumeClaimTemplates:
  # PVC skapas endast om storage enabled
{{- end }}
```

### Nested if:
```yaml
{{- if .Values.mongodb.storage.storageClass }}
storageClassName: {{ .Values.mongodb.storage.storageClass }}
{{- end }}
```

**Logik:**
- Om `storageClass: ""` (tom string) ‚Üí S√§tts INTE
- Om `storageClass: "ebs-sc"` ‚Üí `storageClassName: ebs-sc`

---

## üéØ Tre templates klara!

```
templates/
‚îú‚îÄ‚îÄ _helpers.tpl                    ‚úÖ
‚îú‚îÄ‚îÄ namespace.yaml                  ‚úÖ
‚îú‚îÄ‚îÄ storageclass.yaml               ‚úÖ
‚îî‚îÄ‚îÄ mongodb-statefulset.yaml        ‚úÖ
```

**7 templates kvar!**

---

## üìù Template 4: mongodb-init-job.yaml

1. **New File** ‚Üí `mongodb-init-job.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.initJob.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "todo-app.fullname" . }}-mongodb-init
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongodb-init
spec:
  template:
    spec:
      containers:
      - name: mongo-init
        image: {{ .Values.mongodb.image }}
        command:
        - /bin/bash
        - -c
        - |
          sleep 10
          mongosh mongodb-service:27017/{{ .Values.mongodb.database }} --eval '
            db.TodoItems.insertMany([
              {{- range $index, $todo := .Values.initJob.todos }}
              {{- if $index }},{{ end }}
              {
                "Id": {{ $todo.id }},
                "Name": "{{ $todo.name }}",
                "IsComplete": {{ $todo.isComplete }}
              }
              {{- end }}
            ]);
            print("Database initialized successfully!");
          '          
      restartPolicy: OnFailure
  backoffLimit: {{ .Values.initJob.backoffLimit }}
{{- end }}
```

3. **Spara**

---

## üí° F√∂rklaring - Range (loops):

### Template loop:
```yaml
{{- range $index, $todo := .Values.initJob.todos }}
{
  "Id": {{ $todo.id }},
  "Name": "{{ $todo.name }}"
}
{{- end }}
```

**values.yaml:**
```yaml
initJob:
  todos:
    - id: 1
      name: "Learn Kubernetes"
    - id: 2
      name: "Deploy MongoDB"
```

**Resultat:**
```javascript
{
  "Id": 1,
  "Name": "Learn Kubernetes"
},
{
  "Id": 2,
  "Name": "Deploy MongoDB"
}
```

### Komma-hantering:
```yaml
{{- if $index }},{{ end }}
```

**Logik:**
- F√∂rsta todo ($index = 0) ‚Üí INGET komma
- Andra todo ($index = 1) ‚Üí Komma f√∂re
- Tredje todo ($index = 2) ‚Üí Komma f√∂re

**Perfekt JavaScript-array!** ‚úÖ

---

## üéØ Fyra templates klara!

**3 kvar!** 

___

# üöÄ Forts√§tter med fler templates!

---

## üìù Template 5: webapp-configmap.yaml

1. **New File** ‚Üí `webapp-configmap.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.webapp.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
data:
  MONGODB_HOST: "mongodb-service"
  MONGODB_PORT: "27017"
  MONGODB_DATABASE: {{ .Values.mongodb.database | quote }}
{{- end }}
```

3. **Spara**

---

## üí° F√∂rklaring - quote function:

```yaml
MONGODB_DATABASE: {{ .Values.mongodb.database | quote }}
```

**values.yaml:**
```yaml
mongodb:
  database: ToDoAppDb
```

**Resultat:**
```yaml
MONGODB_DATABASE: "ToDoAppDb"
```

**Varf√∂r quote?**
- S√§kerst√§ller att v√§rdet √§r en string
- Undviker YAML-parsningsfel
- Best practice f√∂r environment-variabler

---

## üìù Template 6: webapp-deployment.yaml

**St√∂rsta templaten - b√•de Service och Deployment!**

1. **New File** ‚Üí `webapp-deployment.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.webapp.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: todo-webapp-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: todo-webapp
  {{- with .Values.webapp.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.webapp.service.type }}
  selector:
    app: todo-webapp
  ports:
  - port: {{ .Values.webapp.service.port }}
    targetPort: {{ .Values.webapp.port }}
    {{- if and (eq .Values.webapp.service.type "NodePort") .Values.webapp.service.nodePort }}
    nodePort: {{ .Values.webapp.service.nodePort }}
    {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-webapp
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: todo-webapp
spec:
  replicas: {{ .Values.webapp.replicas }}
  selector:
    matchLabels:
      app: todo-webapp
  template:
    metadata:
      labels:
        app: todo-webapp
    spec:
      containers:
      - name: webapp
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: {{ .Values.webapp.port }}
        envFrom:
        - configMapRef:
            name: webapp-config
        resources:
          {{- toYaml .Values.webapp.resources | nindent 10 }}
{{- end }}
```

3. **Spara**

---

## üí° F√∂rklaring - Advanced template features:

### 1. with-block (optional annotations):
```yaml
{{- with .Values.webapp.service.annotations }}
annotations:
  {{- toYaml . | nindent 4 }}
{{- end }}
```

**Logik:**
- Om `annotations: {}` (tom) ‚Üí Hela blocket skippas
- Om `annotations: { key: value }` ‚Üí Skapas

**values.yaml (default):**
```yaml
webapp:
  service:
    annotations: {}
```
**‚Üí Inga annotations**

**values-eks-dockerhub.yaml:**
```yaml
webapp:
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```
**‚Üí Annotations skapas!**

---

### 2. and + eq (logical operators):
```yaml
{{- if and (eq .Values.webapp.service.type "NodePort") .Values.webapp.service.nodePort }}
nodePort: {{ .Values.webapp.service.nodePort }}
{{- end }}
```

**Logik:**
- **and** = B√•da villkoren m√•ste vara sanna
- **eq** = Equality check

**√ñversatt:**
```
if (serviceType == "NodePort" AND nodePort != null) {
  nodePort: 30080
}
```

**values.yaml (default):**
```yaml
webapp:
  service:
    type: LoadBalancer  # ‚Üê INTE NodePort
    nodePort: null
```
**‚Üí nodePort s√§tts INTE**

**values-docker-desktop.yaml (om vi hade den):**
```yaml
webapp:
  service:
    type: NodePort      # ‚Üê √ÑR NodePort
    nodePort: 30080     # ‚Üê Inte null
```
**‚Üí nodePort: 30080 skapas!**

---

### 3. String interpolation:
```yaml
image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
```

**values.yaml:**
```yaml
image:
  repository: norajami/todo-app
  tag: latest
```

**Resultat:**
```yaml
image: "norajami/todo-app:latest"
```

---

## üìù Template 7: mongo-express-deployment.yaml (SISTA!)

1. **New File** ‚Üí `mongo-express-deployment.yaml`
2. **Klistra in:**

```yaml
{{- if .Values.mongoExpress.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongo-express
  {{- with .Values.mongoExpress.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.mongoExpress.service.type }}
  selector:
    app: mongo-express
  ports:
  - port: {{ .Values.mongoExpress.service.port }}
    targetPort: {{ .Values.mongoExpress.port }}
    {{- if and (eq .Values.mongoExpress.service.type "NodePort") .Values.mongoExpress.service.nodePort }}
    nodePort: {{ .Values.mongoExpress.service.nodePort }}
    {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app: mongo-express
spec:
  replicas: {{ .Values.mongoExpress.replicas }}
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: {{ .Values.mongoExpress.image }}
        ports:
        - containerPort: {{ .Values.mongoExpress.port }}
        env:
        - name: ME_CONFIG_MONGODB_URL
          value: "mongodb://mongodb-service:27017"
        - name: ME_CONFIG_BASICAUTH_USERNAME
          value: {{ .Values.mongoExpress.username | quote }}
        - name: ME_CONFIG_BASICAUTH_PASSWORD
          value: {{ .Values.mongoExpress.password | quote }}
        resources:
          {{- toYaml .Values.mongoExpress.resources | nindent 10 }}
{{- end }}
```

3. **Spara**

---

## üéâ ALLA TEMPLATES KLARA!

```
templates/
‚îú‚îÄ‚îÄ _helpers.tpl                      ‚úÖ
‚îú‚îÄ‚îÄ NOTES.txt
‚îú‚îÄ‚îÄ namespace.yaml                    ‚úÖ
‚îú‚îÄ‚îÄ storageclass.yaml                 ‚úÖ
‚îú‚îÄ‚îÄ mongodb-statefulset.yaml          ‚úÖ
‚îú‚îÄ‚îÄ mongodb-init-job.yaml             ‚úÖ
‚îú‚îÄ‚îÄ webapp-configmap.yaml             ‚úÖ
‚îú‚îÄ‚îÄ webapp-deployment.yaml            ‚úÖ
‚îî‚îÄ‚îÄ mongo-express-deployment.yaml     ‚úÖ
```

**7 templates skapade!** üéä

---

## ‚úÖ Hela Helm Chart-strukturen:

```
helm-chart/
‚îî‚îÄ‚îÄ todo-app-chart/
    ‚îú‚îÄ‚îÄ Chart.yaml                       ‚úÖ
    ‚îú‚îÄ‚îÄ values.yaml                      ‚úÖ
    ‚îú‚îÄ‚îÄ values-eks-dockerhub.yaml        ‚úÖ
    ‚îú‚îÄ‚îÄ charts/                          (tom, f√∂r dependencies)
    ‚îî‚îÄ‚îÄ templates/
        ‚îú‚îÄ‚îÄ _helpers.tpl                 ‚úÖ
        ‚îú‚îÄ‚îÄ NOTES.txt                    (default, kan editeras)
        ‚îú‚îÄ‚îÄ namespace.yaml               ‚úÖ
        ‚îú‚îÄ‚îÄ storageclass.yaml            ‚úÖ
        ‚îú‚îÄ‚îÄ mongodb-statefulset.yaml     ‚úÖ
        ‚îú‚îÄ‚îÄ mongodb-init-job.yaml        ‚úÖ
        ‚îú‚îÄ‚îÄ webapp-configmap.yaml        ‚úÖ
        ‚îú‚îÄ‚îÄ webapp-deployment.yaml       ‚úÖ
        ‚îî‚îÄ‚îÄ mongo-express-deployment.yaml ‚úÖ
```

---

## üéØ N√§sta steg: Validera och testa!

Nu ska vi:
1. ‚úÖ **Lint** chartet (hitta fel)
2. ‚úÖ **Preview** rendered templates
3. ‚úÖ **Dry-run** install

___

# üîç Steg 9: Validera och Preview Helm Chart

---

## ‚úÖ Steg 9.1: Lint Chart (Hitta fel)

**Lint = Statisk analys av Helm chart**

### I Terminal:

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart/todo-app-chart

helm lint .
```

**F√∂rv√§ntat output:**
```
==> Linting .
[INFO] Chart.yaml: icon is recommended

1 chart(s) linted, 0 chart(s) failed
```

**Vad linting kollar:**
- ‚úÖ Chart.yaml √§r valid
- ‚úÖ Templates har korrekt syntax
- ‚úÖ Inga YAML-parsningsfel
- ‚úÖ Inga felaktiga template-funktioner

**Om du f√•r errors:**
- Kolla felmeddelandet noga
- Vanligt: Felaktig indentation i YAML
- Kolla vilket template som felar

---

## üí° Vanliga lint-warnings (kan ignoreras):

**"icon is recommended"**
- Icon √§r en URL till en bild f√∂r chartet
- Valfritt, beh√∂vs ej f√∂r privata charts

**"keywords are recommended"**
- Vi har keywords, s√• denna kommer inte

**"home is recommended"**
- URL till projektets hemsida
- Valfritt

---

## üî¨ Steg 9.2: Preview Rendered Templates

**Se exakt vad Helm kommer deploya!**

### Preview med default values:

```bash
helm template my-todo-app . 
```

**Detta visar ALL YAML som kommer skapas.**

### Preview med EKS values:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml
```

**Output kommer vara l√•ng!** Du ser:
- Namespace
- StorageClass (eftersom enabled: true i EKS)
- MongoDB StatefulSet
- MongoDB Service
- Init Job
- Webapp Deployment
- Webapp Service
- Mongo Express Deployment
- Mongo Express Service

---

## üîé Steg 9.3: Preview specifikt template

**Se bara ett template:**

```bash
# Bara webapp deployment
helm template my-todo-app . -f values-eks-dockerhub.yaml -s templates/webapp-deployment.yaml
```

**Anv√§ndbart f√∂r:**
- Debugga specifikt template
- Se exakt hur variabler expanderar
- Verifiera logik (if/range/etc)

---

## üíæ Steg 9.4: Spara rendered output

**Bra f√∂r att inspektera offline:**

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml > rendered-eks.yaml
```

**√ñppna sedan i VS Code:**
```bash
code rendered-eks.yaml
```

**Du ser:**
- All YAML som skulle deployats
- Inga `{{ }}` kvar
- Alla variabler ersatta
- Alla if-statements evaluerade

---

## üß™ Steg 9.5: Dry-run (Simulera installation)

**Testa mot Kubernetes API utan att skapa resurser:**

```bash
helm install my-todo-app . -f values-eks-dockerhub.yaml --dry-run --debug
```

**Vad detta g√∂r:**
- ‚úÖ Renderar templates
- ‚úÖ Validerar mot Kubernetes API
- ‚úÖ Kollar om resurser kan skapas
- ‚ùå Skapar INTE resurserna

**Output visar:**
```yaml
---
# Source: todo-app-chart/templates/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: todo-app
  labels:
    helm.sh/chart: todo-app-1.0.0
    app.kubernetes.io/name: todo-app
    ...
---
# Source: todo-app-chart/templates/storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
...
```

---

## üîç Steg 9.6: Verifiera viktiga delar

### Kolla att image √§r r√§tt:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep "image:"
```

**F√∂rv√§ntat:**
```yaml
        image: "norajami/todo-app:latest"
        image: mongo:latest
        image: mongo:latest
        image: mongo-express:latest
```

‚úÖ **Ditt Docker Hub-namn ska synas!**

---

### Kolla att StorageClass skapas f√∂r EKS:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep -A 5 "kind: StorageClass"
```

**F√∂rv√§ntat:**
```yaml
kind: StorageClass
metadata:
  name: ebs-sc
  labels:
    helm.sh/chart: todo-app-1.0.0
provisioner: ebs.csi.eks.amazonaws.com
```

‚úÖ **EBS StorageClass finns!**

---

### Kolla att LoadBalancer annotations finns:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep -A 2 "annotations:"
```

**F√∂rv√§ntat:**
```yaml
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
```

‚úÖ **AWS annotations finns!**

---

### Kolla att replicas √§r r√§tt:

```bash
helm template my-todo-app . -f values-eks-dockerhub.yaml | grep "replicas:"
```

**F√∂rv√§ntat:**
```yaml
  replicas: 1    # MongoDB
  replicas: 2    # WebApp
  replicas: 1    # Mongo Express
```

‚úÖ **Replicas matchar values.yaml!**

---

## üéØ Steg 9.7: Testa --set overrides

**√Ñndra v√§rden via CLI utan att redigera filer:**

```bash
helm template my-todo-app . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=5 \
  --set mongoExpress.enabled=false \
  | grep -E "replicas:|kind: Deployment" 
```

**F√∂rv√§ntat:**
```yaml
kind: Deployment
  replicas: 1    # MongoDB
kind: Deployment
  replicas: 5    # WebApp (√§ndrat fr√•n 2!)
# Mongo Express deployment saknas helt (enabled=false)
```

**Detta visar Helm's flexibilitet!** ‚ú®

---

## ‚úÖ Validering klar!

**Om alla kommandon fungerade:**
- ‚úÖ Chart √§r syntaktiskt korrekt
- ‚úÖ Templates renderar korrekt
- ‚úÖ Variabler expanderar som f√∂rv√§ntat
- ‚úÖ Conditionals fungerar
- ‚úÖ Loops fungerar

---

## üìä Sammanfattning - Validerings-kommandon:

```bash
# 1. Lint
helm lint .

# 2. Preview alla templates
helm template my-todo-app . -f values-eks-dockerhub.yaml

# 3. Preview specifikt template
helm template my-todo-app . -s templates/webapp-deployment.yaml

# 4. Dry-run
helm install my-todo-app . -f values-eks-dockerhub.yaml --dry-run

# 5. Spara rendered YAML
helm template my-todo-app . -f values-eks-dockerhub.yaml > rendered.yaml

# 6. Testa CLI overrides
helm template my-todo-app . --set webapp.replicas=5
```

---

# üöÄ Steg 10: Deployment-kommandon 

---

## üìù Deployment Guide

### üîÑ F√∂rberedelser (om du har EKS-cluster)

```bash
# 1. Verifiera att kubectl √§r anslutet till EKS
kubectl cluster-info

# 2. Kolla att du √§r i r√§tt context
kubectl config current-context

# 3. Verifiera att Docker image finns p√• Docker Hub
# G√• till: https://hub.docker.com/r/norajami/todo-app
```

---

## üöÄ Steg 10.1: Install Chart till EKS

### Install kommando:

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart/todo-app-chart

helm install todo-app-eks . -f values-eks-dockerhub.yaml
```

**F√∂rv√§ntat output:**
```
NAME: todo-app-eks
LAST DEPLOYED: 2025-10-14 13:00:00
NAMESPACE: default
STATUS: deployed
REVISION: 1
```

**Vad h√§nder:**
1. Helm l√§ser `values.yaml` (defaults)
2. Mergar med `values-eks-dockerhub.yaml` (overrides)
3. Renderar alla templates
4. Applicerar till Kubernetes
5. Sparar release-info

---

## üëÄ Steg 10.2: √ñvervaka Deployment

### Lista alla Helm releases:

```bash
helm list
```

**Output:**
```
NAME            NAMESPACE  REVISION  STATUS    CHART           APP VERSION
todo-app-eks    default    1         deployed  todo-app-1.0.0  1.0.0
```

---

### Kolla release status:

```bash
helm status todo-app-eks
```

**Output:**
```
NAME: todo-app-eks
LAST DEPLOYED: ...
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

---

### Kolla Kubernetes-resurser:

```bash
# Alla resurser i namespace
kubectl get all -n todo-app

# Pods
kubectl get pods -n todo-app -w

# Services
kubectl get svc -n todo-app

# PVC
kubectl get pvc -n todo-app

# StorageClass
kubectl get storageclass ebs-sc
```

---

### V√§nta p√• pods:

```bash
# MongoDB
kubectl wait --for=condition=ready pod -l app=mongodb -n todo-app --timeout=300s

# WebApp
kubectl wait --for=condition=ready pod -l app=todo-webapp -n todo-app --timeout=180s

# Mongo Express
kubectl wait --for=condition=ready pod -l app=mongo-express -n todo-app --timeout=180s
```

---

## üåê Steg 10.3: F√• Load Balancer-URL:er

### WebApp URL:

```bash
kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
```

**Eller:**
```bash
WEBAPP_URL=$(kubectl get svc todo-webapp-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
echo "Todo App: http://${WEBAPP_URL}"
```

---

### Mongo Express URL:

```bash
MONGO_EXPRESS_URL=$(kubectl get svc mongo-express-service -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
echo "Mongo Express: http://${MONGO_EXPRESS_URL}"
```

---

### Testa API:

```bash
curl http://${WEBAPP_URL}/api/todos
```

**F√∂rv√§ntat:**
```json
[
  {"id":1,"name":"Learn Kubernetes","isComplete":false},
  {"id":2,"name":"Deploy MongoDB","isComplete":true}
]
```

---

## üîÑ Steg 10.4: Upgrade Release

**Scenario: Du vill √§ndra n√•got (t.ex. fler replicas)**

### Alternativ A: Editera values-fil och upgrade

```bash
# Editera values-eks-dockerhub.yaml
# √Ñndra webapp.replicas fr√•n 2 till 3

helm upgrade todo-app-eks . -f values-eks-dockerhub.yaml
```

---

### Alternativ B: Override via CLI

```bash
helm upgrade todo-app-eks . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=3
```

**F√∂rv√§ntat output:**
```
Release "todo-app-eks" has been upgraded. Happy Helming!
NAME: todo-app-eks
LAST DEPLOYED: 2025-10-14 13:15:00
NAMESPACE: default
STATUS: deployed
REVISION: 2
```

**Notera:** REVISION √∂kade fr√•n 1 ‚Üí 2!

---

### Verifiera upgrade:

```bash
# Kolla att 3 webapp-pods k√∂rs
kubectl get pods -n todo-app -l app=todo-webapp

# Se vad som √§ndrades
helm diff revision todo-app-eks 1 2
# (Kr√§ver helm-diff plugin)
```

---

## üìú Steg 10.5: Release History

### Se alla revisions:

```bash
helm history todo-app-eks
```

**Output:**
```
REVISION  UPDATED                   STATUS      CHART           DESCRIPTION
1         Mon Oct 14 13:00:00 2025  superseded  todo-app-1.0.0  Install complete
2         Mon Oct 14 13:15:00 2025  deployed    todo-app-1.0.0  Upgrade complete
```

---

### Se vilka values som anv√§ndes i revision:

```bash
# Current revision
helm get values todo-app-eks

# Specifik revision
helm get values todo-app-eks --revision 1

# Alla values (inklusive defaults)
helm get values todo-app-eks --all
```

---

### Se manifest f√∂r en revision:

```bash
helm get manifest todo-app-eks --revision 1
```

**Visar exakt YAML som deployades i revision 1.**

---

## ‚èÆÔ∏è Steg 10.6: Rollback

**Scenario: Upgrade gick fel, du vill g√• tillbaka!**

### Rollback till f√∂reg√•ende revision:

```bash
helm rollback todo-app-eks
```

**G√•r tillbaka till revision 1** (2 replicas)

---

### Rollback till specifik revision:

```bash
helm rollback todo-app-eks 1
```

**F√∂rv√§ntat output:**
```
Rollback was a success! Happy Helming!
```

---

### Verifiera rollback:

```bash
# Kolla history
helm history todo-app-eks

# Output:
REVISION  UPDATED                   STATUS      CHART           DESCRIPTION
1         Mon Oct 14 13:00:00 2025  superseded  todo-app-1.0.0  Install complete
2         Mon Oct 14 13:15:00 2025  superseded  todo-app-1.0.0  Upgrade complete
3         Mon Oct 14 13:20:00 2025  deployed    todo-app-1.0.0  Rollback to 1
```

**Notera:** Rollback skapar ny revision (3), som √§r kopia av revision 1!

---

## üóëÔ∏è Steg 10.7: Uninstall Release

### Ta bort release:

```bash
helm uninstall todo-app-eks
```

**F√∂rv√§ntat output:**
```
release "todo-app-eks" uninstalled
```

**Vad som h√§nder:**
- ‚úÖ Alla Kubernetes-resurser raderas
- ‚úÖ Namespace raderas
- ‚úÖ PVCs raderas (MongoDB data f√∂rloras!)
- ‚úÖ LoadBalancers raderas
- ‚ùå History sparas (kan fortfarande ses)

---

### Verifiera att allt √§r borta:

```bash
# Kolla att release √§r borta
helm list

# Kolla att resurser √§r borta
kubectl get all -n todo-app
# Output: Error from server (NotFound): namespaces "todo-app" not found

# Kolla att StorageClass finns kvar (kan anv√§ndas av andra apps)
kubectl get storageclass ebs-sc
```

---

### Uninstall med --keep-history:

```bash
helm uninstall todo-app-eks --keep-history
```

**Skillnad:** History sparas, kan inte re-deploya med samma namn f√∂rr√§n du rensar history.

---

## üéõÔ∏è Steg 10.8: Advanced - CLI Overrides

**√Ñndra flera v√§rden samtidigt:**

```bash
helm install todo-app-eks . \
  -f values-eks-dockerhub.yaml \
  --set webapp.replicas=5 \
  --set mongoExpress.enabled=false \
  --set mongodb.storage.size=2Gi \
  --set image.tag=v2.0.0
```

**Detta overridar:**
- WebApp replicas: 2 ‚Üí 5
- Mongo Express: St√§ngs av helt
- MongoDB storage: 1Gi ‚Üí 2Gi
- Image tag: latest ‚Üí v2.0.0

---

## üì¶ Steg 10.9: Package Chart (Optional)

**Skapa .tgz-fil f√∂r distribution:**

```bash
cd ~/AWS-Kubernetes/todo-app/helm-chart

helm package todo-app-chart
```

**Output:**
```
Successfully packaged chart and saved it to: /path/to/todo-app-1.0.0.tgz
```

**Anv√§ndning:**
- Dela med andra
- Ladda upp till Helm repository
- Version control av chart-paket

---

### Install fr√•n package:

```bash
helm install todo-app-eks todo-app-1.0.0.tgz -f values-eks-dockerhub.yaml
```

---

## üîç Steg 10.10: Troubleshooting-kommandon

### Pod startar inte:

```bash
# Kolla pod status
kubectl get pods -n todo-app

# Describe pod
kubectl describe pod <pod-name> -n todo-app

# Se loggar
kubectl logs <pod-name> -n todo-app

# Se events
kubectl get events -n todo-app --sort-by='.lastTimestamp'
```

---

### LoadBalancer fastnar p√• pending:

```bash
# Describe service
kubectl describe svc todo-webapp-service -n todo-app

# Kolla Load Balancer i AWS Console
# EC2 ‚Üí Load Balancers
```

---

### Helm release fastnat:

```bash
# Se Helm release status
helm status todo-app-eks

# Force delete
helm uninstall todo-app-eks --no-hooks

# Cleanup Kubernetes resources manually
kubectl delete namespace todo-app --force --grace-period=0
```

---

## üìã Sammanfattning - Alla Helm-kommandon:

```bash
# INSTALLATION
helm install <name> . -f values.yaml
helm install <name> . --dry-run --debug

# UPGRADE
helm upgrade <name> . -f values.yaml
helm upgrade <name> . --set key=value

# ROLLBACK
helm rollback <name>
helm rollback <name> <revision>

# INFORMATION
helm list
helm status <name>
helm history <name>
helm get values <name>
helm get manifest <name>

# UNINSTALL
helm uninstall <name>
helm uninstall <name> --keep-history

# VALIDATION
helm lint .
helm template <name> .
helm template <name> . -f values.yaml

# PACKAGING
helm package .
```

---
